/*
This file is part of mzPivotGrid

Copyright (c) 2012-2014 mzSolutions & Software SRL

Contact:  http://www.mzsolutions.eu

Commercial Usage
Licensees holding valid commercial licenses may use this file in accordance 
with the Commercial Software License Agreement provided with the Software.
 
*/

if(Ext.getVersion("extjs").match("4.1")){Ext.define("overrides.dom.Element",{override:"Ext.dom.Element",getAttribute:(Ext.isIE6||Ext.isIE7||Ext.isIE8)?function(a,c){var e=this.dom,b;if(c){b=typeof e[c+":"+a];if(b!="undefined"&&b!="unknown"){return e[c+":"+a]||null}return null}if(a==="for"){a="htmlFor"}return e[a]||null}:function(a,b){var c=this.dom;if(b){return c.getAttributeNS(b,a)||c.getAttribute(b+":"+a)}return c.getAttribute(a)||c[a]||null}})}Ext.define("Mz.aggregate.Aggregators",{singleton:true,sum:function(b,d,a,g,h){var f=b.length,e=0,c;for(c=0;c<f;c++){e+=Ext.Number.from(b[c].get(d),0)}return e},avg:function(b,d,a,g,h){var f=b.length,e=0,c;for(c=0;c<f;c++){e+=Ext.Number.from(b[c].get(d),0)}return f>0?(e/f):0},min:function(d,a,g,j,b){var e=[],c=d.length,f,h;for(f=0;f<c;f++){e.push(d[f].get(a))}h=Ext.Array.min(e);return h},max:function(b,d,a,f,h){var g=[],e=b.length,c;for(c=0;c<e;c++){g.push(b[c].get(d))}v=Ext.Array.max(g);return v},count:function(b,c,a,d,e){return b.length},groupSumPercentage:function(e,b,g,i,c){var a=Mz.aggregate.Aggregators.sum,d=e.length,l,k,f=0,h=0,j=i.split(g.keysSeparator);if(d==0){return 0}j.pop();j=j.join(g.keysSeparator);if(Ext.isEmpty(j)){j=g.grandTotalKey}l=g.results.get(i,c);if(l){f=l.getValue("groupSum");if(!Ext.isDefined(f)){f=l.calculateByFn("groupSum",b,a)}}k=g.results.get(j,c);if(k){h=k.getValue("groupSum");if(!Ext.isDefined(h)){h=k.calculateByFn("groupSum",b,a)}}return(h>0&&f>0)?f/h*100:0},groupCountPercentage:function(d,a,f,h,b){var k=Mz.aggregate.Aggregators.count,c=d.length,l,j,e=0,g=0,i=h.split(f.keysSeparator);if(c==0){return 0}i.pop();i=i.join(f.keysSeparator);if(Ext.isEmpty(i)){i=f.grandTotalKey}l=f.results.get(h,b);if(l){e=l.getValue("groupCount");if(!Ext.isDefined(e)){e=l.calculateByFn("groupCount",a,k)}}j=f.results.get(i,b);if(j){g=j.getValue("groupCount");if(!Ext.isDefined(g)){g=j.calculateByFn("groupCount",a,k)}}return(g>0&&e>0)?e/g*100:0}});Ext.define("Mz.aggregate.MixedCollection",{extend:Ext.util.MixedCollection,removeAt:function(a){var b=this,c=b.callParent(arguments);Ext.destroy(c)},clear:function(){var a=this;Ext.destroy(a.items);a.callParent(arguments)},removeAll:function(){var a=this;Ext.destroy(a.items);a.callParent(arguments)},destroy:function(){this.clear()}});Ext.define("Mz.aggregate.filter.Abstract",{alias:"pivotfilter.abstract",inheritableStatics:{TypeEquals:1,TypeDoesNotEqual:2,TypeGreaterThan:3,TypeGreaterThanOrEqualTo:4,TypeLessThan:5,TypeLessThanOrEqualTo:6,TypeBetween:7,TypeNotBetween:8},mztype:"abstract",type:0,from:null,to:null,value:null,caseSensitive:true,constructor:function(a){Ext.apply(this,a||{})},serialize:function(){var a=this;return Ext.apply({mztype:a.mztype,type:a.type,from:a.from,to:a.to,value:a.value,caseSensitive:a.caseSensitive},this.getSerialArgs()||{})},getSerialArgs:Ext.emptyFn,isMatch:function(e){var d=this,f=Mz.aggregate.matrix.Abstract.prototype.naturalSort,b=(d.caseSensitive?f(e||"",d.value||""):f(String(e||"").toLowerCase(),String(d.value||"").toLowerCase())),a,c;if(d.type==d.self.TypeEquals){return(b===0)}if(d.type==d.self.TypeDoesNotEqual){return(b!==0)}if(d.type==d.self.TypeGreaterThan){return(b>=1)}if(d.type==d.self.TypeGreaterThanOrEqualTo){return(b>=0)}if(d.type==d.self.TypeLessThan){return(b<0)}if(d.type==d.self.TypeLessThanOrEqualTo){return(b<=0)}a=(d.caseSensitive?f(String(e||"").toLowerCase(),String(d.from||"").toLowerCase()):f(e||"",d.from||""));c=(d.caseSensitive?f(String(e||"").toLowerCase(),String(d.to||"").toLowerCase()):f(e||"",d.to||""));if(d.type==d.self.TypeBetween){return(a>=0&&c<=0)}if(d.type==d.self.TypeNotBetween){return !(a>=0&&c<=0)}return true}});Ext.define("Mz.aggregate.filter.Label",{extend:Mz.aggregate.filter.Abstract,alias:"pivotfilter.label",mztype:"label",inheritableStatics:{TypeBeginsWith:21,TypeDoesNotBeginWith:22,TypeEndsWith:23,TypeDoesNotEndWith:24,TypeContains:25,TypeDoesNotContain:26},isMatch:function(b){var a=this;if(a.type==a.self.TypeBeginsWith){return a.startsWith(String(b||""),String(a.value||""),!a.caseSensitive)}if(a.type==a.self.TypeDoesNotBeginWith){return !a.startsWith(String(b||""),String(a.value||""),!a.caseSensitive)}if(a.type==a.self.TypeEndsWith){return a.endsWith(String(b||""),String(a.value||""),!a.caseSensitive)}if(a.type==a.self.TypeDoesNotEndWith){return !a.endsWith(String(b||""),String(a.value||""),!a.caseSensitive)}if(a.type==a.self.TypeContains){return a.stringContains(String(b||""),String(a.value||""),!a.caseSensitive)}if(a.type==a.self.TypeDoesNotContain){return !a.stringContains(String(b||""),String(a.value||""),!a.caseSensitive)}return a.callParent(arguments)},stringContains:function(c,d,b){var a=(d.length<=c.length);if(a){if(b){c=c.toLowerCase();d=d.toLowerCase()}a=(c.lastIndexOf(d)>=0)}return a},startsWith:function(c,d,b){var a=(d.length<=c.length);if(a){if(b){c=c.toLowerCase();d=d.toLowerCase()}a=c.lastIndexOf(d,0)===0}return a},endsWith:function(d,b,c){var a=(start.length<=d.length);if(a){if(c){d=d.toLowerCase();b=b.toLowerCase()}a=d.indexOf(b,d.length-b.length)!==-1}return a}});Ext.define("Mz.aggregate.filter.Value",{extend:Mz.aggregate.filter.Abstract,alias:"pivotfilter.value",mztype:"value",inheritableStatics:{TypeTop10:31},dimensionId:"",topType:"items",topOrder:"top",topSort:true,isTopFilter:false,constructor:function(){var a=this;a.callParent(arguments);a.isTopFilter=(a.type==a.self.TypeTop10)},getSerialArgs:function(){var a=this;return{dimensionId:a.dimensionId,topType:a.topType,topOrder:a.topOrder}},applyFilter:function(c,e){var d=this,a=d.topSort?e:Ext.Array.clone(e),b=[];if(e.length==0){return b}d.sortItemsByGrandTotal(c,a);switch(d.topType){case"items":b=d.extractTop10Items(a);break;case"sum":b=d.extractTop10Sum(a);break;case"percent":b=d.extractTop10Percent(c,a);break}if(!d.topSort){a.length=0}return b},extractTop10Items:function(a){var c=this,d=[],b;for(b=0;b<a.length;b++){if(d.indexOf(a[b]["tempVar"])<0){d.push(a[b]["tempVar"]);if(d.length>c.value||(c.value<b+1&&b>0)){break}}}return Ext.Array.slice(a,b)},extractTop10Sum:function(a){var d=this,c=0,b;for(b=0;b<a.length;b++){c+=a[b]["tempVar"];if(c>=d.value){break}}return Ext.Array.slice(a,b+1)},extractTop10Percent:function(b,g){var h=this,e=0,k=g[0].key.split(b.matrix.keysSeparator),c,d,f,j,l,a;k.length--;j=(k.length>0?k.join(b.matrix.keysSeparator):b.matrix.grandTotalKey);d=(b.leftAxis?j:b.matrix.grandTotalKey);f=(b.leftAxis?b.matrix.grandTotalKey:j);l=b.matrix.results.get(d,f);a=(l?l.getValue(h.dimensionId):0);for(c=0;c<g.length;c++){e+=g[c]["tempVar"];if((e*100/a)>=h.value){break}}return Ext.Array.slice(g,c+1)},sortItemsByGrandTotal:function(d,b){var e=this,g,f,a,c;for(c=0;c<b.length;c++){g=(d.leftAxis?b[c].key:d.matrix.grandTotalKey);f=(d.leftAxis?d.matrix.grandTotalKey:b[c].key);a=d.matrix.results.get(g,f);b[c]["tempVar"]=(a?a.getValue(e.dimensionId):0)}Ext.Array.sort(b,function(j,i){var h=d.matrix.naturalSort(j.tempVar,i.tempVar);if(h<0&&e.topOrder==="top"){return 1}if(h>0&&e.topOrder==="top"){return -1}return h})}});Ext.define("Mz.aggregate.dimension.Item",{header:"",dataIndex:"",sortIndex:"",width:100,flex:0,align:"left",sortable:true,direction:"ASC",sorterFn:null,caseSensitiveSort:true,filter:null,renderer:null,grouperFn:null,blankText:"(blank)",showZeroAsBlank:false,aggregator:"sum",isAggregate:false,id:"",values:null,matrix:null,constructor:function(a){var b=this;b.initialConfig=a||{};if(a.isAggregate===true&&Ext.isEmpty(a.align)){a.align="left"}Ext.apply(b,a||{});if(Ext.isEmpty(b.id)){b.id=Ext.id()}if(b.isAggregate){if(Ext.isEmpty(b.dataIndex)&&Ext.isDefined(b.measure)){b.dataIndex=b.measure;delete b.measure}if(Ext.isEmpty(b.aggregator)){b.aggregator="sum"}if(Ext.isString(b.aggregator)){b.aggregatorFn=Mz.aggregate.Aggregators[b.aggregator]}else{if(Ext.isFunction(b.aggregator)){b.aggregatorFn=b.aggregator}}b.filter=false}else{if(Ext.isObject(b.filter)){Ext.applyIf(b.filter,{mztype:"label"});b.filter=Ext.createByAlias("pivotfilter."+b.filter.mztype,b.filter)}else{b.filter=false}}if(!Ext.isFunction(b.grouperFn)){b.grouperFn=b.defaultGrouperFn}if(b.sortable&&!b.sorterFn){b.sorterFn=b.defaultSorterFn}if(Ext.isEmpty(b.sortIndex)){b.sortIndex=b.dataIndex}if(!b.renderer){b.renderer=b.getDefaultFormatRenderer(b.isAggregate?"0,000.00":"")}else{if(Ext.isString(b.renderer)){b.renderer=b.getDefaultFormatRenderer(b.renderer)}}b.values=Ext.create("Mz.aggregate.MixedCollection");b.values.getKey=function(c){return c.value};b.callParent(arguments)},destroy:function(){var a=this;Ext.destroy(a.values,a.filter);if(a.matrix){delete (a.matrix)}},serialize:function(){var a=this;return{id:a.id,header:a.header,dataIndex:a.dataIndex,sortIndex:a.sortIndex,width:a.width,flex:a.flex,align:a.align,sortable:a.sortable,direction:a.direction,caseSensitiveSort:a.caseSensitiveSort,filter:a.filter?a.filter.serialize():null,aggregator:Ext.isString(a.aggregator)?a.aggregator:"sum",showZeroAsBlank:a.showZeroAsBlank}},addValue:function(b,c){var a=this;if(!a.values.getByKey(b)){a.values.add({value:b,display:c})}},getValues:function(){return this.values},getId:function(){return this.id},defaultSorterFn:function(f,e){var d=this,c=f.sortValue,b=e.sortValue,a;if(c instanceof Date){c=c.getTime()}if(b instanceof Date){b=b.getTime()}if(!d.caseSensitiveSort){c=String(c).toUpperCase();b=String(b).toUpperCase()}a=Mz.aggregate.matrix.Abstract.prototype.naturalSort(c,b);if(a<0&&d.direction==="DESC"){return 1}if(a>0&&d.direction==="DESC"){return -1}return a},getDefaultFormatRenderer:function(b){var a=this;return function(d){var c;if(Ext.isEmpty(b)){return d}if(Ext.isFunction(b)){return b.call(a,d)}if(!Ext.isNumber(d)){return d}if(a.isAggregate&&d===0&&a.showZeroAsBlank){return""}c=(d>=0);d=Math.abs(d);d=Ext.util.Format.number(d,b);return c?d:"-"+d}},defaultGrouperFn:function(a){return a.get(this.dataIndex)}});Ext.define("Mz.aggregate.axis.Item",{level:0,key:"",value:"",sortValue:"",name:"",dimensionId:"",dimension:null,children:null,record:null,axis:null,data:null,expanded:false,constructor:function(a){var b=this;Ext.apply(b,a||{});if(Ext.isEmpty(b.sortValue)){b.sortValue=b.value}b.callParent(arguments)},destroy:function(){var a=this;if(a.axis){delete a.axis}if(a.data){delete a.data}if(a.dimension){delete a.dimension}if(a.record){delete a.record}if(Ext.isArray(a.children)){a.children.length=0}a.callParent(arguments)},getTextTotal:function(){var b=this,a;if(Ext.XTemplate.getTpl){a=Ext.XTemplate.getTpl(b.axis.matrix,"textTotalTpl")}else{a=new Ext.XTemplate(b.axis.matrix.textTotalTpl)}return a.apply({groupField:b.dimension.dataIndex,columnName:b.dimension.dataIndex,name:b.name,rows:b.children||[]})}});Ext.define("Mz.aggregate.axis.Abstract",{alias:"pivotaxis.abstract",dimensions:null,matrix:null,items:null,tree:null,levels:0,leftAxis:false,constructor:function(a){var c=this,b,d;if(!a||!a.matrix){Ext.log("Wrong initialization of the axis!");return}c.leftAxis=a.leftAxis||c.leftAxis;c.matrix=a.matrix;c.tree=[];c.dimensions=Ext.create("Mz.aggregate.MixedCollection");c.dimensions.getKey=function(e){return e.getId()};c.items=Ext.create("Mz.aggregate.MixedCollection");c.items.getKey=function(e){return e.key};Ext.Array.each(Ext.Array.from(a.dimensions||[]),c.addDimension,c)},destroy:function(){var a=this;Ext.destroyMembers(a,"dimensions","items","tree");if(a.matrix){delete a.matrix}},addDimension:function(a){var b=this;if(a){b.dimensions.add(Ext.create("Mz.aggregate.dimension.Item",Ext.apply({matrix:b.matrix},a)))}},addItem:function(b){var a=this;if(!Ext.isObject(b)||Ext.isEmpty(b.key)||Ext.isEmpty(b.value)||Ext.isEmpty(b.name)||Ext.isEmpty(b.dimensionId)){return false}b.key=String(b.key);b.dimension=a.dimensions.getByKey(b.dimensionId);b.dimension.addValue(b.value,b.name);b.axis=a;if(!a.items.getByKey(b.key)&&b.dimension){a.items.add(Ext.create("Mz.aggregate.axis.Item",b));return true}return false},clear:function(){var a=this;a.items.clear();a.tree=null},getTree:function(){var a=this;if(Ext.isEmpty(a.tree)){a.buildTree()}return a.tree},findTreeElement:function(d,e){var c=this,a=arguments[2]||c.tree||[],g=arguments[3]||1;var b=Ext.Array.filter(a,function(j,h,i){return Ext.isDate(e)?Ext.Date.isEqual(j[d],e):j[d]===e},c);if(b.length>0){return{level:g,node:b[0]}}var f=null;Ext.Array.each(a,function(j,h,i){if(j.children){f=this.findTreeElement(d,e,j.children,g+1);if(f){return false}}},c);return f},buildTree:function(){var b=this,a;b.tree=[];b.items.each(b.addItemToTree,b);b.sortTree()},addItemToTree:function(e){var d=this,c=String(e.key).split(d.matrix.keysSeparator),a="",b;c=Ext.Array.slice(c,0,c.length-1);a=c.join(d.matrix.keysSeparator);b=d.findTreeElement("key",a);if(b){e.level=b.level;e.data=Ext.clone(b.node.data||{});b.node.children=b.node.children||[];b.node.children.push(e)}else{e.level=0;e.data={};d.tree.push(e)}e.data[e.dimension.getId()]=e.name;d.levels=Math.max(d.levels,e.level)},sortTree:function(){var a=arguments[0]||this.tree,b;if(a.length>0){b=a[0].dimension}if(b&&b.sortable===true){Ext.Array.sort(a,function(d,c){return b.sorterFn(d,c)})}Ext.Array.each(a,function(c){if(c.children){this.sortTree(c.children)}},this)},sortTreeByField:function(f,g){var e=this,i=arguments[2]||e.tree,d,c,h,b=false,a=!arguments[2];if(a){e.recordIndexer=-1}if(i.length>0){d=i[0].dimension;c=i[0].record}g=g||"ASC";if(d&&(d.sortable===true)&&(d.getId()==f)){h=d.direction;d.direction=g;Ext.Array.sort(i,function(k,j){return d.sorterFn(k,j)});d.direction=h;return true}if(c){e.sortTreeRecords(i,f,g);Ext.Array.each(i,function(j){e.recordIndexer++;j.record.index=e.recordIndexer});return true}else{e.sortTreeLeaves(i,f,g);Ext.Array.each(i,function(j){if(j.children){b=this.sortTreeByField(f,g,j.children)||b}},e)}if(a&&e.matrix.pivotStore&&e.matrix.pivotStore.data){e.matrix.pivotStore.data.sort("index","ASC")}return b},sortTreeRecords:function(a,d,c){var b=this;c=c||"ASC";Ext.Array.sort(a||[],function(g,f){var e,i=g.record,h=f.record;if(!(i&&i.isModel&&h&&h.isModel)){return 0}e=b.matrix.naturalSort(i.get(d)||"",h.get(d)||"");if(e<0&&c==="DESC"){return 1}if(e>0&&c==="DESC"){return -1}return e})},sortTreeLeaves:function(c,h,g){var f=this,e=Ext.Array.pluck(f.matrix.model,"name"),b=e.indexOf(h),d,a;if(b<0){return false}d=f.matrix.model[b]["col"];a=f.matrix.model[b]["agg"];g=g||"ASC";Ext.Array.sort(c||[],function(k,j){var i,m,l;m=f.matrix.results.get(k.key,d);if(m){m=m.getValue(a)}else{m=0}l=f.matrix.results.get(j.key,d);if(l){l=l.getValue(a)}else{l=0}i=f.matrix.naturalSort(m,l);if(i<0&&g==="DESC"){return 1}if(i>0&&g==="DESC"){return -1}return i})}});Ext.define("Mz.aggregate.axis.Local",{extend:Mz.aggregate.axis.Abstract,alias:"pivotaxis.local",addRecord:function(e){var g=this,m=[],b,h="",j=g.dimensions.getCount(),a,n,l,c,d,k=true,f=[];for(d=0;d<j;d++){c=g.dimensions.getAt(d);a=c.grouperFn(e);n=h?h+g.matrix.keysSeparator:"";a=Ext.isEmpty(a)?c.blankText:a;n+=g.matrix.formatKeys(a);l=c.renderer(a);if(Ext.isEmpty(l)){l=a}if(c.filter instanceof Mz.aggregate.filter.Label){k=c.filter.isMatch(l)}if(!k){break}f.push({name:l,value:a,sortValue:e.get(c.sortIndex),key:n,dimensionId:c.getId()});h=n;m.push(n)}if(k){for(d=0;d<f.length;d++){g.addItem(f[d])}return m}else{return null}},buildTree:function(){var a=this;a.callParent(arguments);a.filterTree()},filterTree:function(){var d=this,c=d.dimensions.getCount(),a=false,b;for(b=0;b<c;b++){a=a||(d.dimensions.getAt(b).filter instanceof Mz.aggregate.filter.Value)}if(!a){return}d.matrix.filterApplied=true;d.filterTreeItems(d.tree)},filterTreeItems:function(a){var d=this,c,b,e;if(!a||!Ext.isArray(a)||a.length<=0){return}c=a[0].dimension.filter;if(c&&(c instanceof Mz.aggregate.filter.Value)){if(c.isTopFilter){e=c.applyFilter(d,a)||[]}else{e=Ext.Array.filter(a,d.canRemoveItem,d)}d.removeRecordsFromResults(e);d.removeItemsFromArray(a,e);for(b=0;b<e.length;b++){d.items.remove(e[b])}}for(b=0;b<a.length;b++){if(a[b].children){d.filterTreeItems(a[b].children);if(a[b].children.length===0){d.items.remove(a[b]);Ext.Array.erase(a,b,1);b--}}}},canRemoveItem:function(d){var c=this,f=(c.leftAxis?d.key:c.matrix.grandTotalKey),e=(c.leftAxis?c.matrix.grandTotalKey:d.key),a=c.matrix.results.get(f,e),b=d.dimension.filter;return(a?!b.isMatch(a.getValue(b.dimensionId)):false)},removeItemsFromArray:function(c,a){for(var b=0;b<c.length;b++){if(Ext.Array.indexOf(a,c[b])>=0){Ext.Array.erase(c,b,1);b--}}},removeRecordsFromResults:function(a){for(var b=0;b<a.length;b++){this.removeRecordsByItem(a[b])}},removeRecordsByItem:function(g){var f=this,e,c,b,a,d;if(f.leftAxis){d=f.matrix.results.get(g.key,f.matrix.grandTotalKey);b=f.matrix.results.getByLeftKey(f.matrix.grandTotalKey)}else{d=f.matrix.results.get(f.matrix.grandTotalKey,g.key);b=f.matrix.results.getByTopKey(f.matrix.grandTotalKey)}if(!d){return}for(c=0;c<b.length;c++){f.removeItemsFromArray(b[c].records,d.records)}e=g.key.split(f.matrix.keysSeparator);e.length=e.length-1;while(e.length>0){if(f.leftAxis){b=f.matrix.results.getByLeftKey(e.join(f.matrix.keysSeparator))}else{b=f.matrix.results.getByTopKey(e.join(f.matrix.keysSeparator))}for(c=0;c<b.length;c++){f.removeItemsFromArray(b[c].records,d.records)}e.length=e.length-1}}});Ext.define("Mz.aggregate.matrix.Result",{leftKey:"",topKey:"",dirty:false,records:null,values:null,matrix:null,constructor:function(a){var b=this;Ext.apply(b,a||{});b.records=[];b.values={}},destroy:function(){var a=this;a.records.length=0;delete a.records;delete a.matrix;if(a.values){delete a.values}if(a.leftAxisItem){delete a.leftAxisItem}if(a.topAxisItem){delete a.topAxisItem}a.callParent(arguments)},calculate:function(){var c=this,a,d,b=c.matrix.aggregate.getCount();for(a=0;a<b;a++){d=c.matrix.aggregate.getAt(a);c.addValue(d.getId(),d.aggregatorFn(c.records,d.dataIndex,c.matrix,c.leftKey,c.topKey))}},calculateByFn:function(d,c,a){var e=this,b=a(e.records,c,e.matrix,e.leftKey,e.topKey);e.addValue(d,b);return b},addValue:function(b,a){this.values[b]=a},getValue:function(a){return this.values[a]},addRecord:function(a){this.records.push(a)},getLeftAxisItem:function(){return this.matrix.leftAxis.items.getByKey(this.leftKey)},getTopAxisItem:function(){return this.matrix.topAxis.items.getByKey(this.topKey)}});Ext.define("Mz.aggregate.matrix.Results",{items:null,matrix:null,constructor:function(a){var b=this;b.matrix=a;b.items=Ext.create("Mz.aggregate.MixedCollection");b.items.getKey=function(c){return c.leftKey+"/"+c.topKey};b.callParent(arguments)},destroy:function(){var a=this;delete a.matrix;Ext.destroy(a.items);a.callParent(arguments)},clear:function(){this.items.clear()},add:function(d,b){var a=this,c=a.get(d,b);if(!c){c=a.items.add(Ext.create("Mz.aggregate.matrix.Result",{leftKey:d,topKey:b,matrix:a.matrix}))}return c},get:function(b,a){return this.items.getByKey(b+"/"+a)},getByLeftKey:function(b){var a=this.items.filterBy(function(e,c){var d=String(c).split("/");return(b==d[0])});return a.getRange()},getByTopKey:function(b){var a=this.items.filterBy(function(e,c){var d=String(c).split("/");return(d.length>1&&b==d[1])});return a.getRange()},calculate:function(){this.items.each(function(a){a.calculate()})}});Ext.define("Mz.aggregate.matrix.Abstract",{extend:Ext.util.Observable,alias:"pivotmatrix.abstract",mztype:"abstract",mztypeLeftAxis:"abstract",mztypeTopAxis:"abstract",textRowLabels:"Row labels",textTotalTpl:"Total ({name})",textGrandTotalTpl:"Grand total",keysSeparator:"#_#",grandTotalKey:"#mzgrandtotal#",compactViewKey:"#compactview#",viewLayoutType:"outline",rowSubTotalsPosition:"first",rowGrandTotalsPosition:"first",colSubTotalsPosition:"first",colGrandTotalsPosition:"first",showZeroAsBlank:false,leftAxis:null,topAxis:null,aggregate:null,results:null,pivotStore:null,isDestroyed:false,constructor:function(a){var b=this;b.callParent(arguments);if(!Ext.getVersion("extjs").match(5)){b.addEvents("cleardata","start","progress","done","modelbuilt","columnsbuilt","recordbuilt","buildtotals","storebuilt")}b.initialize(true,a)},destroy:function(){var a=this;a.delayedTask.cancel();delete (a.delayedTask);if(Ext.isFunction(a.onDestroy)){a.onDestroy()}Ext.destroy(a.results,a.leftAxis,a.topAxis,a.aggregate,a.pivotStore);if(Ext.isArray(a.columns)){a.columns.length=0}delete (a.columns);if(Ext.isArray(a.model)){a.model.length=0}delete (a.model);if(Ext.isArray(a.totals)){a.totals.length=0}delete (a.totals);a.isDestroyed=true;a.callParent(arguments)},formatKeys:function(){var c=this,b=Ext.Array.from(arguments),a=[];Ext.Array.each(b,function(d){if(!Ext.isEmpty(d)){a.push(c.crc32(d))}});return a.join(c.keysSeparator).toString()},crc32:function(f,d){var c="00000000 77073096 EE0E612C 990951BA 076DC419 706AF48F E963A535 9E6495A3 0EDB8832 79DCB8A4 E0D5E91E 97D2D988 09B64C2B 7EB17CBD E7B82D07 90BF1D91 1DB71064 6AB020F2 F3B97148 84BE41DE 1ADAD47D 6DDDE4EB F4D4B551 83D385C7 136C9856 646BA8C0 FD62F97A 8A65C9EC 14015C4F 63066CD9 FA0F3D63 8D080DF5 3B6E20C8 4C69105E D56041E4 A2677172 3C03E4D1 4B04D447 D20D85FD A50AB56B 35B5A8FA 42B2986C DBBBC9D6 ACBCF940 32D86CE3 45DF5C75 DCD60DCF ABD13D59 26D930AC 51DE003A C8D75180 BFD06116 21B4F4B5 56B3C423 CFBA9599 B8BDA50F 2802B89E 5F058808 C60CD9B2 B10BE924 2F6F7C87 58684C11 C1611DAB B6662D3D 76DC4190 01DB7106 98D220BC EFD5102A 71B18589 06B6B51F 9FBFE4A5 E8B8D433 7807C9A2 0F00F934 9609A88E E10E9818 7F6A0DBB 086D3D2D 91646C97 E6635C01 6B6B51F4 1C6C6162 856530D8 F262004E 6C0695ED 1B01A57B 8208F4C1 F50FC457 65B0D9C6 12B7E950 8BBEB8EA FCB9887C 62DD1DDF 15DA2D49 8CD37CF3 FBD44C65 4DB26158 3AB551CE A3BC0074 D4BB30E2 4ADFA541 3DD895D7 A4D1C46D D3D6F4FB 4369E96A 346ED9FC AD678846 DA60B8D0 44042D73 33031DE5 AA0A4C5F DD0D7CC9 5005713C 270241AA BE0B1010 C90C2086 5768B525 206F85B3 B966D409 CE61E49F 5EDEF90E 29D9C998 B0D09822 C7D7A8B4 59B33D17 2EB40D81 B7BD5C3B C0BA6CAD EDB88320 9ABFB3B6 03B6E20C 74B1D29A EAD54739 9DD277AF 04DB2615 73DC1683 E3630B12 94643B84 0D6D6A3E 7A6A5AA8 E40ECF0B 9309FF9D 0A00AE27 7D079EB1 F00F9344 8708A3D2 1E01F268 6906C2FE F762575D 806567CB 196C3671 6E6B06E7 FED41B76 89D32BE0 10DA7A5A 67DD4ACC F9B9DF6F 8EBEEFF9 17B7BE43 60B08ED5 D6D6A3E8 A1D1937E 38D8C2C4 4FDFF252 D1BB67F1 A6BC5767 3FB506DD 48B2364B D80D2BDA AF0A1B4C 36034AF6 41047A60 DF60EFC3 A867DF55 316E8EEF 4669BE79 CB61B38C BC66831A 256FD2A0 5268E236 CC0C7795 BB0B4703 220216B9 5505262F C5BA3BBE B2BD0B28 2BB45A92 5CB36A04 C2D7FFA7 B5D0CF31 2CD99E8B 5BDEAE1D 9B64C2B0 EC63F226 756AA39C 026D930A 9C0906A9 EB0E363F 72076785 05005713 95BF4A82 E2B87A14 7BB12BAE 0CB61B38 92D28E9B E5D5BE0D 7CDCEFB7 0BDBDF21 86D3D2D4 F1D4E242 68DDB3F8 1FDA836E 81BE16CD F6B9265B 6FB077E1 18B74777 88085AE6 FF0F6A70 66063BCA 11010B5C 8F659EFF F862AE69 616BFFD3 166CCF45 A00AE278 D70DD2EE 4E048354 3903B3C2 A7672661 D06016F7 4969474D 3E6E77DB AED16A4A D9D65ADC 40DF0B66 37D83BF0 A9BCAE53 DEBB9EC5 47B2CF7F 30B5FFE9 BDBDF21C CABAC28A 53B39330 24B4A3A6 BAD03605 CDD70693 54DE5729 23D967BF B3667A2E C4614AB8 5D681B02 2A6F2B94 B40BBE37 C30C8EA1 5A05DF1B 2D02EF8D",g=0,a=0;if(!Ext.isDefined(d)){d=0}d=d^(-1);f=f.toString();for(var b=0,e=f.length;b<e;b++){g=(d^f.charCodeAt(b))&255;a="0x"+c.substr(g*9,8);d=(d>>>8)^a}return d^(-1)},naturalSort:function(c,a){var e=/^(\d+|-\d+)(.*)$/;c=c||"";a=a||"";while(true){if(c===a){return 0}if(c===""){return -1}if(a===""){return 1}var d=e.exec(c);var b=e.exec(a);if((d!=null)&&(b!=null)){if(d[1]!=b[1]){return d[1]-b[1]}c=d[2];a=b[2]}else{d=c.toString().charCodeAt(0);b=a.toString().charCodeAt(0);if(d!=b){return d-b}c=c.toString().substr(1);a=a.toString().substr(1)}}},initialize:function(e,a){var d=this,c=["viewLayoutType","rowSubTotalsPosition","rowGrandTotalsPosition","colSubTotalsPosition","colGrandTotalsPosition","showZeroAsBlank"],b;d.initResults();d.initAggregates(a.aggregate||[]);d.initAxis(a.leftAxis||[],a.topAxis||[]);for(b=0;b<c.length;b++){if(a.hasOwnProperty(c[b])){d[c[b]]=a[c[b]]}}d.totals=[];if(e){d.pivotStore=Ext.create("Ext.data.ArrayStore",{autoDestroy:false,fields:[]});d.delayedTask=new Ext.util.DelayedTask(d.startProcess,d);if(Ext.isFunction(d.onInitialize)){d.onInitialize()}}},onInitialize:Ext.emptyFn,onDestroy:Ext.emptyFn,reconfigure:function(a){var b=this,a=Ext.clone(a||{});b.initialize(false,a);b.clearData();if(Ext.isFunction(b.onReconfigure)){b.onReconfigure(a)}b.delayedTask.delay(5)},onReconfigure:Ext.emptyFn,initResults:function(){var a=this;Ext.destroy(a.results);a.results=Ext.create("Mz.aggregate.matrix.Results",a)},initAggregates:function(d){var c=this,a,b;Ext.destroy(c.aggregate);c.aggregate=Ext.create("Mz.aggregate.MixedCollection");c.aggregate.getKey=function(e){return e.getId()};if(Ext.isEmpty(d)){return}d=Ext.Array.from(d);for(a=0;a<d.length;a++){b=d[a];Ext.applyIf(b,{isAggregate:true,align:"right",showZeroAsBlank:c.showZeroAsBlank});c.aggregate.add(Ext.create("Mz.aggregate.dimension.Item",b))}},initAxis:function(c,a){var b=this;c=Ext.Array.from(c||[]);a=Ext.Array.from(a||[]);Ext.destroy(b.leftAxis);b.leftAxis=Ext.createByAlias("pivotaxis."+b.mztypeLeftAxis,{matrix:b,dimensions:c,leftAxis:true});Ext.destroy(b.topAxis);b.topAxis=Ext.createByAlias("pivotaxis."+b.mztypeTopAxis,{matrix:b,dimensions:a,leftAxis:false})},clearData:function(){var a=this;a.fireEvent("cleardata",a);a.leftAxis.clear();a.topAxis.clear();a.results.clear();if(Ext.isArray(a.columns)){a.columns.length=0}if(Ext.isArray(a.model)){a.model.length=0}a.totals=[];if(a.pivotStore){a.pivotStore.removeAll(true)}},startProcess:Ext.emptyFn,endProcess:function(){var b=this,a,c;a=b.leftAxis.getTree();c=b.topAxis.getTree();b.buildModelAndColumns();b.buildPivotStore();if(Ext.isFunction(b.onBuildStore)){b.onBuildStore(b.pivotStore)}b.fireEvent("storebuilt",b,b.pivotStore);b.fireEvent("done")},onBuildModel:Ext.emptyFn,onBuildColumns:Ext.emptyFn,onBuildRecord:Ext.emptyFn,onBuildTotals:Ext.emptyFn,onBuildStore:Ext.emptyFn,buildModelAndColumns:function(){var a=this;a.model=[{name:"id",type:"string"}];a.buildColumnHeaders(false)},buildColumnHeaders:function(a){var b=this;b.internalCounter=0;b.columns=[];if(b.viewLayoutType=="compact"){b.generateCompactLeftAxis(a)}else{b.leftAxis.dimensions.each(function(c){b.parseLeftAxisDimension(c,a)},b)}if(b.colGrandTotalsPosition=="first"){b.columns.push(b.parseAggregateForColumn(null,{text:b.textGrandTotalTpl,grandTotal:true},a))}Ext.Array.each(b.topAxis.getTree(),function(c){b.parseTopAxisItem(c,a)},b);if(b.colGrandTotalsPosition=="last"){b.columns.push(b.parseAggregateForColumn(null,{text:b.textGrandTotalTpl,grandTotal:true},a))}if(!a){if(Ext.isFunction(b.onBuildModel)){b.onBuildModel(b.model)}b.fireEvent("modelbuilt",b,b.model)}if(Ext.isFunction(b.onBuildColumns)){b.onBuildColumns(b.columns)}b.fireEvent("columnsbuilt",b,b.columns)},parseLeftAxisDimension:function(c,a){var b=this;if(!a){b.model.push({name:c.getId(),type:"string"})}b.columns.push({dataIndex:c.getId(),text:c.header,dimension:c,leftAxis:true})},generateCompactLeftAxis:function(a){var b=this;if(!a){b.model.push({name:b.compactViewKey,type:"string"})}b.columns.push({dataIndex:b.compactViewKey,text:b.textRowLabels,leftAxis:true,width:200})},parseTopAxisItem:function(f,a){var e=this,c=[],b=[],h,d,g=false;if(!f.children){c=e.parseAggregateForColumn(f,null,a);if(f.level===0){e.columns.push(c)}else{return c}}else{if(e.colSubTotalsPosition=="first"){d=e.addColSummary(f,a,true);if(d){b.push(d)}}Ext.Array.each(f.children,function(j){var i=e.parseTopAxisItem(j,a);if(Ext.isArray(i)){c=Ext.Array.merge(c,i)}else{c.push(i)}});if(f.expanded||!a){h={text:f.name,columns:c,key:f.key,xcollapsible:f.expanded,xexpanded:f.expanded,xexpandable:true};if(f.level===0){e.columns.push(h)}b.push(h)}if(e.colSubTotalsPosition=="last"){d=e.addColSummary(f,a,true);if(d){b.push(d)}}if(e.colSubTotalsPosition=="none"){d=e.addColSummary(f,a,false);if(d){b.push(d)}}return b}},addColSummary:function(d,a,f){var c=this,b,e=false;b=c.parseAggregateForColumn(d,{text:d.expanded?d.getTextTotal():d.name,subTotal:true},a);if(f){e=true}else{e=!d.expanded}if(e){if(d.level===0){c.columns.push(b)}Ext.apply(b,{key:d.key,xcollapsible:!d.expanded,xexpanded:d.expanded,xexpandable:!d.expanded});return b}},parseAggregateForColumn:function(f,b,a){var e=this,c=[],d={};e.aggregate.each(function(g){e.internalCounter++;if(!a){e.model.push({name:"c"+e.internalCounter,type:"auto",defaultValue:undefined,useNull:true,col:f?f.key:e.grandTotalKey,agg:g.getId()})}c.push({dataIndex:"c"+e.internalCounter,text:g.header,topAxis:true,subTotal:(b?b.subTotal===true:false),grandTotal:(b?b.grandTotal===true:false),dimension:g})});if(c.length==0&&e.aggregate.getCount()==0){e.internalCounter++;d=Ext.apply({text:f?f.name:"",dataIndex:"c"+e.internalCounter},b||{})}else{if(c.length==1){d=Ext.applyIf({text:f?f.name:""},c[0]);Ext.apply(d,b||{});if(b&&b.grandTotal&&e.aggregate.getCount()==1){d.text=e.aggregate.getAt(0).header||b.text}}else{d=Ext.apply({text:f?f.name:"",columns:c},b||{})}}return d},buildPivotStore:function(){var a=this;if(Ext.isFunction(a.pivotStore.model.setFields)){a.pivotStore.model.setFields(a.model)}else{a.pivotStore.model.replaceFields(a.model,true)}a.pivotStore.removeAll(true);Ext.Array.each(a.leftAxis.getTree(),a.addRecordToPivotStore,a);a.addGrandTotalsToPivotStore()},addGrandTotalsToPivotStore:function(){var b=this,a=[];a.push({title:b.textGrandTotalTpl,values:b.preparePivotStoreRecordData({key:b.grandTotalKey})});if(Ext.isFunction(b.onBuildTotals)){b.onBuildTotals(a)}b.fireEvent("buildtotals",b,a);Ext.Array.forEach(a,function(c){if(Ext.isObject(c)&&Ext.isObject(c.values)){b.totals.push({title:c.title||"",record:b.pivotStore.add(c.values)[0]})}})},addRecordToPivotStore:function(c){var b=this,a;if(!c.children){a=b.pivotStore.add(b.preparePivotStoreRecordData(c));c.record=a[0];if(Ext.isFunction(b.onBuildRecord)){b.onBuildRecord(a[0])}b.fireEvent("recordbuilt",b,a[0])}else{Ext.Array.each(c.children,function(d){b.addRecordToPivotStore(d)})}},preparePivotStoreRecordData:function(c){var a=this,b={};b.id=c.key;Ext.apply(b,c.data||{});Ext.Array.each(a.model,function(e){var d;if(e.col&&e.agg){d=a.results.get(c.key,e.col);if(d){b[e.name]=d.getValue(e.agg)}}});if(a.viewLayoutType=="compact"){b[a.compactViewKey]=c.name}return b},getColumns:function(){return this.model},getColumnHeaders:function(){var a=this;if(!a.model){a.buildModelAndColumns()}else{a.buildColumnHeaders(true)}return a.columns},isGroupRow:function(a){var b=this.leftAxis.findTreeElement("key",a);if(!b){return false}return(b.node["children"]&&b.node["children"].length==0)?0:b.level},isGroupCol:function(a){var b=this.topAxis.findTreeElement("key",a);if(!b){return false}return(b.node["children"]&&b.node["children"].length==0)?0:b.level}});Ext.define("Mz.aggregate.matrix.Local",{extend:Mz.aggregate.matrix.Abstract,alias:"pivotmatrix.local",mztype:"local",mztypeLeftAxis:"local",mztypeTopAxis:"local",store:null,recordsPerJob:1000,timeBetweenJobs:2,constructor:function(){var a=this;a.callParent(arguments);if(!Ext.getVersion("extjs").match(5)){a.addEvents("beforeupdate","afterupdate")}},onInitialize:function(){var a=this;a.localDelayedTask=new Ext.util.DelayedTask(a.delayedProcess,a);a.newRecordsDelayedTask=new Ext.util.DelayedTask(a.onOriginalStoreAddDelayed,a);a.updateRecordsDelayedTask=new Ext.util.DelayedTask(a.onOriginalStoreUpdateDelayed,a);a.callParent(arguments)},onReconfigure:function(c){var d=this,a,b;if(c.store){b=c.store}else{if(d.store){if(d.store.isStore&&!d.storeListeners){a=d.store}else{b=d.store}}}if(b){a=Ext.getStore(b||"");if(Ext.isEmpty(a)&&Ext.isString(b)){a=Ext.create(b)}}if(a&&a.isStore){Ext.destroy(d.storeListeners);if(d.store&&d.store.autoDestroy&&a!=d.store){Ext.destroy(d.store)}d.store=a;d.storeListeners=d.store.on({refresh:d.startProcess,beforeload:d.onOriginalStoreBeforeLoad,add:d.onOriginalStoreAdd,update:d.onOriginalStoreUpdate,remove:d.onOriginalStoreRemove,clear:d.startProcess,scope:d,destroyable:true})}d.callParent(arguments)},onDestroy:function(){var a=this;a.localDelayedTask.cancel();a.localDelayedTask=null;a.newRecordsDelayedTask.cancel();a.newRecordsDelayedTask=null;a.updateRecordsDelayedTask.cancel();a.updateRecordsDelayedTask=null;if(Ext.isArray(a.records)){a.records.length=0}delete (a.records);Ext.destroy(a.storeListeners);if(a.store&&a.store.isStore&&a.store.autoDestroy){Ext.destroy(a.store)}a.callParent(arguments)},onOriginalStoreBeforeLoad:function(a){var b=this;b.fireEvent("start",b)},onOriginalStoreAdd:function(b,a){var c=this;c.newRecords=c.newRecords||[];c.newRecords=Ext.Array.merge(c.newRecords,Ext.Array.from(a));c.newRecordsDelayedTask.delay(100)},onOriginalStoreAddDelayed:function(){var c=this,b,a;a=Ext.Array.from(c.newRecords||[]);for(b=0;b<a.length;b++){c.processRecord(a[b],b,a.length)}c.newRecords=[];c.leftAxis.tree=null;c.leftAxis.buildTree();c.topAxis.tree=null;c.topAxis.buildTree();c.recalculateResults(c.store,a)},onOriginalStoreUpdate:function(b,a){var c=this;c.updateRecords=c.updateRecords||[];c.updateRecords=Ext.Array.merge(c.updateRecords,Ext.Array.from(a));c.updateRecordsDelayedTask.delay(100)},onOriginalStoreUpdateDelayed:function(){var a=this;a.recalculateResults(a.store,a.updateRecords);a.updateRecords.length=0},onOriginalStoreRemove:function(c,a,d,b){if(b){return}this.startProcess()},isReallyDirty:function(b,a){var c=this,d=true;a=Ext.Array.from(a);c.leftAxis.dimensions.each(function(e){Ext.Array.forEach(a,function(f){d=(f&&f.isModel&&e.values.containsKey(f.get(e.dataIndex)));return d});return d});return !d},recalculateResults:function(b,a){var c=this;if(c.isReallyDirty(b,a)){c.startProcess();return}c.fireEvent("beforeupdate",c);c.results.calculate();Ext.Array.each(c.leftAxis.getTree(),c.updateRecordToPivotStore,c);c.updateGrandTotalsToPivotStore();c.fireEvent("afterupdate",c)},updateGrandTotalsToPivotStore:function(){var c=this,b=[],a;if(c.totals.length<=0){return}b.push({title:c.textGrandTotalTpl,values:c.preparePivotStoreRecordData({key:c.grandTotalKey})});if(Ext.isFunction(c.onBuildTotals)){c.onBuildTotals(b)}c.fireEvent("buildtotals",c,b);if(c.totals.length===b.length){for(a=0;a<c.totals.length;a++){if(Ext.isObject(b[a])&&Ext.isObject(b[a].values)&&(c.totals[a].record instanceof Ext.data.Model)){delete (b[a].values.id);c.totals[a].record.set(b[a].values)}}}},updateRecordToPivotStore:function(b){var a=this;if(!b.children){if(b.record){b.record.set(a.preparePivotStoreRecordData(b))}}else{Ext.Array.each(b.children,function(c){a.updateRecordToPivotStore(c)})}},startProcess:function(){var a=this;if(!a.store||(a.store&&!a.store.isStore)||a.isDestroyed){return}a.clearData();a.localDelayedTask.delay(50)},delayedProcess:function(){var a=this;a.fireEvent("start",a);a.records=a.store.getRange();if(a.records.length==0){a.endProcess();return}a.statusInProgress=false;a.processRecords(0)},processRecords:function(a){var c=this,b=a,d=c.records.length;if(c.isDestroyed){return}c.statusInProgress=true;while(b<d&&b<a+c.recordsPerJob&&c.statusInProgress){c.processRecord(c.records[b],b,d);b++}if(b>=d){c.statusInProgress=false;c.results.calculate();c.leftAxis.buildTree();c.topAxis.buildTree();if(c.filterApplied){c.results.calculate()}c.endProcess();return}if(c.statusInProgress&&d>0){Ext.defer(c.processRecords,c.timeBetweenJobs,c,[b])}},processRecord:function(d,e,a){var g=this,h=g.grandTotalKey,k,f,c,b;k=g.leftAxis.addRecord(d);f=g.topAxis.addRecord(d);if(k&&f){g.results.add(h,h).addRecord(d)}if(k){for(c=0;c<k.length;c++){g.results.add(k[c],h).addRecord(d);if(f){for(b=0;b<f.length;b++){g.results.add(k[c],f[b]).addRecord(d)}}}if(f){for(b=0;b<f.length;b++){g.results.add(h,f[b]).addRecord(d)}}}g.fireEvent("progress",g,e+1,a)},getRecordsByRowGroup:function(d){var c=this.results.getByLeftKey(d),e=c.length,a=[],b;for(b=0;b<e;b++){a=Ext.Array.merge(a,c[b].records||[])}return a},getRecordsByColGroup:function(d){var c=this.results.getByTopKey(d),e=c.length,a=[],b;for(b=0;b<e;b++){a=Ext.Array.merge(a,c[b].records||[])}return a},getRecordsByGroups:function(c,b){var a=this.results.get(c,b);return(a?a.records||[]:[])}});Ext.define("Mz.aggregate.matrix.Remote",{extend:Mz.aggregate.matrix.Abstract,alias:"pivotmatrix.remote",mztype:"remote",url:"",onInitialize:function(){var a=this;a.remoteDelayedTask=new Ext.util.DelayedTask(a.delayedProcess,a);a.callParent(arguments)},startProcess:function(){var a=this;if(Ext.isEmpty(a.url)){return}a.clearData();a.fireEvent("start",a);a.statusInProgress=false;a.remoteDelayedTask.delay(5)},delayedProcess:function(){var d=this,c=[],a=[],b=[];d.leftAxis.dimensions.each(function(e){c.push(e.serialize())});d.topAxis.dimensions.each(function(e){a.push(e.serialize())});d.aggregate.each(function(e){b.push(e.serialize())});Ext.Ajax.request({url:d.url,jsonData:{leftAxis:c,topAxis:a,aggregate:b},success:d.processRemoteResults,failure:d.processFailed,scope:d})},processRemoteResults:function(a,c){var b=this,d=Ext.JSON.decode(a.responseText,true);if(!d||!d.success){b.endProcess();return}Ext.Array.each(Ext.Array.from(d.leftAxis||[]),function(e){if(Ext.isObject(e)){b.leftAxis.addItem(e)}});Ext.Array.each(Ext.Array.from(d.topAxis||[]),function(e){if(Ext.isObject(e)){b.topAxis.addItem(e)}});Ext.Array.each(Ext.Array.from(d.results||[]),function(f){if(Ext.isObject(f)){var e=b.results.add(f.leftKey||"",f.topKey||"");Ext.Object.each(f.values||{},e.addValue,e)}});b.endProcess()},processFailed:function(){this.endProcess()}});Ext.define("Mz.pivot.feature.PivotStore",{constructor:function(a){var b=this;Ext.apply(b,a);b.bindStore(a.store)},destroy:function(){var a=this;delete a.store;delete a.matrix;delete a.pivotFeature;delete a.storeInfo;Ext.destroy(a.storeListeners);a.callParent(arguments)},bindStore:function(a){var b=this;if(b.store){Ext.destroy(b.storeListeners);b.store=null}if(a){b.storeListeners=a.on({pivotstoreremodel:b.processStore,scope:b,destroyable:true});b.store=a}},processStore:function(){if(!this.matrix){return}var c=this,e=c.data,b=c["processGroup"+Ext.String.capitalize(c.matrix.viewLayoutType)],a=c.matrix.getColumns(),d;if(Ext.isFunction(c.store.model.setFields)){c.store.model.setFields(a)}else{c.store.model.replaceFields(a,true)}c.store.removeAll(true);c.store.suspendEvents(false);c.storeInfo={};if(!Ext.isFunction(b)){b=c.processGroupOutline}d=Ext.Function.bind(b,c);if(c.matrix.rowGrandTotalsPosition=="first"){c.processGrandTotal()}Ext.Array.each(c.matrix.leftAxis.getTree(),function(h,f,g){c.store.add(d({group:h,previousExpanded:(f>0?g[f-1].expanded:false)}))},c);if(c.matrix.rowGrandTotalsPosition=="last"){c.processGrandTotal()}c.store.resumeEvents();c.store.fireEvent("refresh",c.store)},processGroup:function(a){var c=this,b=c["processGroup"+Ext.String.capitalize(c.matrix.viewLayoutType)],d;if(!Ext.isFunction(b)){b=c.processGroupOutline}d=Ext.Function.bind(b,c);return d(a)},createGridStoreRecord:function(b){var c=this,d=c.matrix.preparePivotStoreRecordData(b||{}),a;d.id="";a=new c.store.model(d);if(Ext.isEmpty(b)){Ext.Object.each(d,function(e){if(e!="id"){a.set(e,null)}});a.commit()}a.isPlaceholder=true;return a},processGrandTotal:function(){var a=this,b=false,c={key:a.matrix.grandTotalKey};Ext.Array.forEach(a.matrix.totals||[],function(f){var d=f.record,e=a.matrix.leftAxis.dimensions.getCount();if(!(d instanceof Ext.data.Model)){return}a.storeInfo[d.internalId]={leftKey:c.key,rowStyle:"",rowClasses:[a.pivotFeature.gridMaster.clsGrandTotal,a.pivotFeature.summaryDataCls],rendererParams:{}};a.matrix.leftAxis.dimensions.each(function(i,g){var h;if(a.matrix.viewLayoutType=="compact"||g===0){if(a.matrix.viewLayoutType=="compact"){h=a.matrix.compactViewKey;e=1}else{h=i.getId()}d.set(h,f.title);d.commit(false,[h]);a.storeInfo[d.internalId].rendererParams[h]={fn:"groupOutlineRenderer",group:c,colspan:e,hidden:false,subtotalRow:true};b=true}else{a.storeInfo[d.internalId].rendererParams[i.getId()]={fn:"groupOutlineRenderer",group:c,colspan:0,hidden:b,subtotalRow:true};e--}a.storeInfo[d.internalId].rendererParams.topaxis={fn:"topAxisRenderer"}});a.store.add(d)})},processGroupOutline:function(a){var c=this,d=a.group,b=[];if(d.record){c.processRecordOutline({results:b,group:d})}else{c.processGroupOutlineWithChildren({results:b,group:d,previousExpanded:a.previousExpanded})}return b},processGroupOutlineWithChildren:function(c){var f=this,g=c.group,b=c.previousExpanded,e=false,a,d;if(!g.expanded||(g.expanded&&f.matrix.rowSubTotalsPosition=="first")){e=true;a=f.createGridStoreRecord(g)}else{if(f.matrix.rowSubTotalsPosition=="last"||f.matrix.rowSubTotalsPosition=="none"){a=f.createGridStoreRecord();a.set(g.dimension.getId(),g.name)}}a.commit();f.processGroupHeaderRecordOutline({results:c.results,group:g,record:a,previousExpanded:b,hasSummaryData:e});if(g.expanded){if(g.children){for(d=0;d<g.children.length;d++){if(g.children[d]["children"]){f.processGroupOutlineWithChildren({results:c.results,group:g.children[d]})}else{f.processRecordOutline({results:c.results,group:g.children[d]})}}}if(f.matrix.rowSubTotalsPosition=="last"){a=f.createGridStoreRecord(g);a.set(g.dimension.getId(),g.getTextTotal());a.commit();f.processGroupHeaderRecordOutline({results:c.results,group:g,record:a,previousExpanded:b,subtotalRow:true,hasSummaryData:true})}}},processGroupHeaderRecordOutline:function(a){var f=this,g=a.group,d=a.record,b=a.previousExpanded,h=a.subtotalRow,e=a.hasSummaryData,c=f.matrix.leftAxis.dimensions.getCount(),j=false;f.storeInfo[d.internalId]={leftKey:g.key,rowStyle:"",rowClasses:[f.pivotFeature.gridMaster.clsGroupTotal,e?f.pivotFeature.summaryDataCls:""],rendererParams:{}};f.matrix.leftAxis.dimensions.each(function(k,i){if(k.getId()==g.dimension.getId()){f.storeInfo[d.internalId].rendererParams[k.getId()]={fn:"groupOutlineRenderer",group:g,colspan:c,hidden:false,previousExpanded:b,subtotalRow:h};j=true}else{f.storeInfo[d.internalId].rendererParams[k.getId()]={fn:"groupOutlineRenderer",group:g,colspan:0,hidden:j,previousExpanded:b,subtotalRow:h};c--}});f.storeInfo[d.internalId].rendererParams.topaxis={fn:(e?"topAxisRenderer":"topAxisNoRenderer")};a.results.push(d)},processRecordOutline:function(b){var c=this,e=b.group,d=false,a=e.record;c.storeInfo[a.internalId]={leftKey:e.key,rowStyle:"",rowClasses:[c.pivotFeature.rowCls,c.pivotFeature.summaryDataCls],rendererParams:{}};c.matrix.leftAxis.dimensions.each(function(g,f){if(g.getId()==e.dimension.getId()){d=true}c.storeInfo[a.internalId].rendererParams[g.getId()]={fn:"recordOutlineRenderer",group:e,hidden:!d}});c.storeInfo[a.internalId].rendererParams.topaxis={fn:"topAxisRenderer"};b.results.push(a)},processGroupCompact:function(b){var d=this,e=b.group,a=b.previousExpanded,c=[];if(e.record){d.processRecordCompact({results:c,group:e})}else{d.processGroupCompactWithChildren({results:c,group:e,previousExpanded:a})}return c},processGroupCompactWithChildren:function(c){var f=this,g=c.group,b=c.previousExpanded,e=false,a,d;if(!g.expanded||(g.expanded&&f.matrix.rowSubTotalsPosition=="first")){e=true;a=f.createGridStoreRecord(g)}else{if(f.matrix.rowSubTotalsPosition=="last"||f.matrix.rowSubTotalsPosition=="none"){a=f.createGridStoreRecord();a.set(f.matrix.compactViewKey,g.name)}}a.commit();f.processGroupHeaderRecordCompact({results:c.results,group:g,record:a,previousExpanded:b,hasSummaryData:e});if(g.expanded){if(g.children){for(d=0;d<g.children.length;d++){if(g.children[d]["children"]){f.processGroupCompactWithChildren({results:c.results,group:g.children[d]})}else{f.processRecordCompact({results:c.results,group:g.children[d]})}}}if(f.matrix.rowSubTotalsPosition=="last"){a=f.createGridStoreRecord(g);a.set(f.matrix.compactViewKey,g.getTextTotal());a.commit();f.processGroupHeaderRecordCompact({results:c.results,group:g,record:a,previousExpanded:b,subtotalRow:true,hasSummaryData:true})}}},processGroupHeaderRecordCompact:function(a){var f=this,g=a.group,d=a.record,b=a.previousExpanded,h=a.subtotalRow,e=a.hasSummaryData,c=f.matrix.leftAxis.dimensions.getCount(),j=false;f.storeInfo[d.internalId]={leftKey:g.key,rowStyle:"",rowClasses:[f.pivotFeature.gridMaster.clsGroupTotal,e?f.pivotFeature.summaryDataCls:""],rendererParams:{}};f.storeInfo[d.internalId].rendererParams[f.matrix.compactViewKey]={fn:"groupCompactRenderer",group:g,colspan:0,previousExpanded:b,subtotalRow:h};f.storeInfo[d.internalId].rendererParams.topaxis={fn:(e?"topAxisRenderer":"topAxisNoRenderer")};a.results.push(d)},processRecordCompact:function(b){var c=this,e=b.group,d=false,a=c.createGridStoreRecord(e);c.storeInfo[a.internalId]={leftKey:e.key,rowStyle:"",rowClasses:[c.pivotFeature.rowCls,c.pivotFeature.summaryDataCls],rendererParams:{}};c.storeInfo[a.internalId].rendererParams[c.matrix.compactViewKey]={fn:"recordCompactRenderer",group:e};c.storeInfo[a.internalId].rendererParams.topaxis={fn:"topAxisRenderer"};b.results.push(a)},doExpandCollapse:function(d,a){var e=this,c=Ext.getVersion("extjs"),b=e.pivotFeature.gridMaster,f;f=e.matrix.leftAxis.findTreeElement("key",d);if(!f){return}if(c.match("4.1")){e.doExpandCollapse41(f,a)}else{if(c.match("4.2")){e.doExpandCollapse42(f,a)}else{if(c.isGreaterThanOrEqual&&c.isGreaterThanOrEqual(5)){e.doExpandCollapse50(f,a)}}}b.fireEvent((f.node.expanded?"pivotgroupexpand":"pivotgroupcollapse"),b,"row",f.node)},doExpandCollapse41:function(c,a){var b=this;b.store.suspendEvents(false);b.doExpandCollapseInternal.apply(b,arguments);b.store.resumeEvents();b.store.fireEvent("refresh",b.store)},doExpandCollapse42:function(e,a){var d=this,b=Ext.getVersion("extjs"),c=b.isGreaterThanOrEqual("4.2.1");d.store.suspendEvents(false);d.doExpandCollapseInternal.apply(d,arguments);d.store.resumeEvents();if(d.pivotFeature.view.bufferedRenderer){d.pivotFeature.view.refresh();if(c){d.pivotFeature.view.bufferedRenderer.setBodyTop(d.pivotFeature.view.bufferedRenderer.bodyTop)}if(d.pivotFeature.lockingPartner){d.pivotFeature.lockingPartner.view.refresh();if(c){d.pivotFeature.lockingPartner.view.bufferedRenderer.setBodyTop(d.pivotFeature.lockingPartner.view.bufferedRenderer.bodyTop)}}}else{d.store.fireEvent("refresh",d.store)}},doExpandCollapse50:function(c,a){var b=this;b.doExpandCollapseInternal.apply(b,arguments)},doExpandCollapseInternal:function(f,b){var e=this,c,g,d,a;g=e.processGroup({group:f.node,previousExpanded:false});f.node.expanded=!f.node.expanded;c=e.processGroup({group:f.node,previousExpanded:false});if(c.length&&(d=e.store.indexOf(b))!==-1){if(f.node.expanded){e.store.removeAt(d);e.store.insert(d,c);e.removeStoreInfoData([b])}else{a=g.length;g=e.store.getRange(d,d+a-1);e.store.remove(g);e.store.insert(d,c);e.removeStoreInfoData(g)}}},removeStoreInfoData:function(a){var b=this;Ext.Array.each(a,function(c){if(b.storeInfo[c.internalId]){delete b.storeInfo[c.internalId]}})}});Ext.define("Mz.pivot.feature.PivotEvents",{extend:Ext.grid.feature.Feature,alias:"feature.pivotevents",eventPrefix:"pivotcell",eventSelector:"."+Ext.baseCSSPrefix+"grid-cell",lockedViewGridCls:Ext.baseCSSPrefix+"pivot-gridview-locked",summaryDataCls:Ext.baseCSSPrefix+"pivot-summary-data",summaryDataSelector:"."+Ext.baseCSSPrefix+"pivot-summary-data",cellSelector:"."+Ext.baseCSSPrefix+"grid-cell",groupHeaderCls:Ext.baseCSSPrefix+"pivot-group-header",groupHeaderCollapsibleCls:Ext.baseCSSPrefix+"pivot-group-header-collapsible",summaryRowCls:Ext.baseCSSPrefix+"grid-group-total",summaryRowSelector:"."+Ext.baseCSSPrefix+"grid-group-total",grandSummaryRowCls:Ext.baseCSSPrefix+"grid-grand-total",grandSummaryRowSelector:"."+Ext.baseCSSPrefix+"grid-grand-total",init:function(b){var d=this,a=d.view,c;d.initEventsListeners();d.callParent(arguments);c=d.lockingPartner;if(c&&c.dataSource){d.dataSource=c.dataSource}else{d.dataSource=new Mz.pivot.feature.PivotStore({store:d.grid.store,pivotFeature:d})}},destroy:function(){var a=this;delete a.view;delete a.grid;if(a.gridMaster){delete a.gridMaster}if(a.matrix){delete a.matrix}a.destroyEventsListeners();a.callParent(arguments)},initEventsListeners:function(){var a=this;a.eventsViewListeners=a.view.on(Ext.apply({scope:a,destroyable:true},a.getViewListeners()||{}));a.gridListeners=a.grid.on(Ext.apply({scope:a,destroyable:true},a.getGridListeners()||{}))},getViewListeners:function(){var b=this,a={afterrender:b.onViewAfterRender};a[b.eventPrefix+"click"]=b.onCellEvent;a[b.eventPrefix+"dblclick"]=b.onCellEvent;a[b.eventPrefix+"contextmenu"]=b.onCellEvent;return a},getGridListeners:Ext.emptyFn,destroyEventsListeners:function(){var a=this;Ext.destroy(a.eventsViewListeners,a.gridListeners)},onViewAfterRender:function(){var b=this,a=Ext.getVersion("extjs");b.gridMaster=b.view.up("mzpivotgrid");b.matrix=b.gridMaster.getMatrix();b.dataSource.matrix=b.matrix;if(a.match("4.2")&&b.gridMaster.getView().lockedGrid){b.gridMaster.getView().lockedGrid.getView().addCls(b.lockedViewGridCls)}},getRowId:function(a){return this.view.id+"-record-"+a.internalId},getRecord:function(a){return this.view.getRecord(a)},onCellEvent:function(l,a,i){var k=this,o=-1,p=Ext.fly(a).findParent(k.summaryDataSelector)||Ext.fly(a).findParent(k.summaryRowSelector),n,j,g,o,b,m,f,h,d=k.getRecord(p),c={grid:k.gridMaster,view:k.view,cellEl:a};if(!p||!d){return false}f=k.dataSource.storeInfo[d.internalId].leftKey;p=Ext.fly(p);if(p.hasCls(k.grandSummaryRowCls)){g="pivottotal"}else{if(p.hasCls(k.summaryRowCls)){g="pivotgroup"}else{if(p.hasCls(k.summaryDataCls)){g="pivotitem"}}}o=Ext.getDom(a).getAttribute("columnid");b=k.getColumnHeaderById(o);Ext.apply(c,{columnId:o,column:b,leftKey:f});if(Ext.fly(a).hasCls(k.groupHeaderCls)){}else{if(b){g+="cell";m=k.getTopAxisGroupByDataIndex(b.dataIndex);if(m){h=m.col;Ext.apply(c,{topKey:h,dimensionId:m.agg})}}}j=k.gridMaster.fireEvent(g+i.type,c,i);if(j!==false&&i.type=="click"&&Ext.fly(a).hasCls(k.groupHeaderCollapsibleCls)){k.dataSource.doExpandCollapse(f,d);if(!k.view.bufferedRenderer&&Ext.fly(k.getRowId(d))){Ext.fly(k.getRowId(d)).scrollIntoView(k.view.el,false,false)}}return false},getColumnHeaderById:function(d){var c=this,b=c.view.getGridColumns(),a;for(a=0;a<b.length;a++){if(b[a].id===d){return b[a]}}},getTopAxisGroupByDataIndex:function(c){var d=this,b=d.gridMaster.matrix.getColumns(),a;for(a=0;a<b.length;a++){if(b[a].name===c){return b[a]}}}});Ext.define("Mz.pivot.feature.PivotViewCommon",{extend:Mz.pivot.feature.PivotEvents,groupTitleCls:Ext.baseCSSPrefix+"pivot-group-title",groupHeaderCollapsedCls:Ext.baseCSSPrefix+"pivot-group-header-collapsed",tableCls:Ext.baseCSSPrefix+"grid-table",rowCls:Ext.baseCSSPrefix+"grid-row",dirtyCls:Ext.baseCSSPrefix+"grid-dirty-cell",outlineCellHiddenCls:Ext.baseCSSPrefix+"pivot-outline-cell-hidden",outlineCellGroupExpandedCls:Ext.baseCSSPrefix+"pivot-outline-cell-previous-expanded",compactGroupHeaderCls:Ext.baseCSSPrefix+"pivot-group-header-compact",compactLayoutPadding:25,cellTpl:["{%",'values.hideCell = values.tdAttr == "hidden";\n',"%}",'<tpl if="!hideCell">','<td class="{tdCls}" {tdAttr} data-columnid="{column.id}" columnid="{column.id}" columnindex="{columnIndex}">','<div {unselectableAttr} class="'+Ext.baseCSSPrefix+'grid-cell-inner"','style="text-align:{align};<tpl if="style">{style}</tpl>">{value}</div>',"</td>","</tpl>",{priority:200}],rtlCellTpl:["{%",'values.hideCell = values.tdAttr == "hidden";\n',"%}",'<tpl if="!hideCell">','<td class="{tdCls}" {tdAttr} data-columnid="{column.id}" columnid="{column.id}" columnindex="{columnIndex}">','<div {unselectableAttr} class="'+Ext.baseCSSPrefix+'grid-cell-inner"','style="text-align:{[this.getAlign(values.align)]};<tpl if="style">{style}</tpl>">{value}</div>',"</td>","</tpl>",{priority:200,rtlAlign:{right:"left",left:"right",center:"center"},getAlign:function(a){return this.rtlAlign[a]}}],setup:function(){var a=this;a.columns=a.view.getGridColumns()},isRTL:function(){var b=this,a=b.gridMaster||b.grid;if(Ext.isFunction(a.isLocalRtl)){return a.isLocalRtl()}return false},setRenderers:function(a){var b=this;Ext.Array.each(b.columns,function(c){if(Ext.isDefined(a[c.dataIndex])){c.savedRenderer=c.renderer;c.renderer=b[a[c.dataIndex].fn](Ext.apply({renderer:c.savedRenderer},a[c.dataIndex]))}else{if(Ext.isDefined(a.topaxis)){c.savedRenderer=c.renderer;c.renderer=b[a.topaxis.fn](Ext.apply({renderer:c.savedRenderer},a[c.dataIndex]))}}})},resetRenderers:function(){var a=this;Ext.Array.each(a.columns,function(b){if(Ext.isDefined(b.savedRenderer)){b.renderer=b.savedRenderer;delete b.savedRenderer}})},groupOutlineRenderer:function(b){var e=this,c=b.renderer,g=b.group,h=b.colspan,f=b.hidden,a=b.previousExpanded,d=b.subtotalRow;return function(n,k,j,o,m,l,i){if(Ext.isFunction(c)){n=c.apply(this,arguments)}n=e.encodeValue(n,g);if(h>0){k.tdAttr='id="'+g.key+'" colspan = "'+h+'"';k.tdCls=e.groupHeaderCls;if(!d){k.tdCls+=" "+e.groupHeaderCollapsibleCls;if(!g.expanded){k.tdCls+=" "+e.groupHeaderCollapsedCls}if(a){k.tdCls+=" "+e.outlineCellGroupExpandedCls}}return'<div class="'+e.groupTitleCls+'">'+n+"</div>"}if(f){k.tdAttr="hidden"}k.tdCls=e.outlineCellHiddenCls;return""}},recordOutlineRenderer:function(a){var c=this,b=a.renderer,e=a.group,d=a.hidden;return function(k,h,g,l,j,i,f){if(Ext.isFunction(b)){k=b.apply(this,arguments)}k=c.encodeValue(k,e);if(d){h.tdCls=c.outlineCellHiddenCls;return""}h.tdCls=c.groupHeaderCls+" "+c.groupTitleCls;return k}},groupCompactRenderer:function(b){var e=this,c=b.renderer,f=b.group,g=b.colspan,a=b.previousExpanded,d=b.subtotalRow;return function(m,j,i,n,l,k,h){if(Ext.isFunction(c)){m=c.apply(this,arguments)}m=e.encodeValue(m,f);if(f.level>0){j.style=(e.isRTL()?"margin-right: ":"margin-left: ")+(e.compactLayoutPadding*f.level)+"px;"}j.tdAttr='id="'+f.key+'"';j.tdCls=e.groupHeaderCls+" "+e.compactGroupHeaderCls;if(!d){j.tdCls+=" "+e.groupHeaderCollapsibleCls;if(!f.expanded){j.tdCls+=" "+e.groupHeaderCollapsedCls}if(a){j.tdCls+=" "+e.outlineCellGroupExpandedCls}}return'<div class="'+e.groupTitleCls+'">'+m+"</div>"}},recordCompactRenderer:function(a){var c=this,b=a.renderer,d=a.group;return function(j,g,f,k,i,h,e){if(Ext.isFunction(b)){j=b.apply(this,arguments)}j=c.encodeValue(j,d);if(d.level>0){g.style=(c.isRTL()?"margin-right: ":"margin-left: ")+(c.compactLayoutPadding*d.level)+"px;"}g.tdCls=c.groupHeaderCls+" "+c.groupTitleCls+" "+c.compactGroupHeaderCls;return j}},topAxisNoRenderer:function(a){return function(g,d,c,h,f,e,b){return""}},topAxisRenderer:function(a){var c=this,b=a.renderer;return function(i,f,e,k,h,g,d){var j=(i===0&&c.gridMaster.showZeroAsBlank);if(Ext.isFunction(b)){i=b.apply(this,arguments)}return j?"":i}},encodeValue:function(a,b){return a}});Ext.define("Mz.pivot.feature.PivotView50",{extend:Mz.pivot.feature.PivotViewCommon,alias:"feature.pivotview50",outerTpl:["{%","var me = this.pivotViewFeature;","if (!(me.disabled)) {","me.setup();","}","this.nextTpl.applyOut(values, out, parent);","%}",{priority:200}],rowTpl:["{%","var me = this.pivotViewFeature;","me.setupRowData(values.record, values.rowIndex, values);","values.view.renderColumnSizer(values, out);","this.nextTpl.applyOut(values, out, parent);","me.resetRenderers();","%}",{priority:200,syncRowHeights:function(d,a){var b,c;d=Ext.fly(d,"syncDest");if(d){b=d.offsetHeight}a=Ext.fly(a,"sycSrc");if(a){c=a.offsetHeight}if(d&&a){if(b>c){Ext.fly(a).setHeight(b)}else{if(c>b){Ext.fly(d).setHeight(c)}}}}}],init:function(b){var c=this,a=c.view;c.callParent(arguments);a.addTpl(Ext.XTemplate.getTpl(c,"outerTpl")).pivotViewFeature=c;a.addRowTpl(Ext.XTemplate.getTpl(c,"rowTpl")).pivotViewFeature=c;a.preserveScrollOnRefresh=true;if(a.bufferedRenderer){a.bufferedRenderer.variableRowHeight=true}else{b.variableRowHeight=a.variableRowHeight=true}},getViewListeners:function(){var a=this;return Ext.apply(a.callParent(arguments)||{},{refresh:a.onViewReady})},getGridListeners:function(){var a=this;return Ext.apply(a.callParent(arguments)||{},{beforerender:a.onBeforeGridRendered})},onBeforeGridRendered:function(a){var b=this;if(b.isRTL()){b.view.addCellTpl(Ext.XTemplate.getTpl(b,"rtlCellTpl"))}else{b.view.addCellTpl(Ext.XTemplate.getTpl(b,"cellTpl"))}if(b.view.bufferedRenderer&&Ext.isFunction(b.view.bufferedRenderer.onRangeFetched)){b.view.bufferedRenderer.onRangeFetched=Ext.Function.createSequence(b.view.bufferedRenderer.onRangeFetched,function(){b.onViewReady()})}},onViewReady:function(){var a=this;if(a.gridMaster&&a.gridMaster.syncRowHeights&&a.lockingPartner&&a.view.bufferedRenderer){a.gridMaster.syncRowHeights()}},vetoEvent:function(a,c,d,b){if(b.type!=="mouseover"&&b.type!=="mouseout"&&b.type!=="mouseenter"&&b.type!=="mouseleave"&&b.getTarget(this.eventSelector)){return false}},setupRowData:function(b,a,f){var d=this,e=d.dataSource.storeInfo[b.internalId],c=e?e.rendererParams:{};f.rowClasses.length=0;Ext.Array.insert(f.rowClasses,0,e?e.rowClasses:[]);d.setRenderers(c)}});Ext.define("Mz.pivot.feature.PivotView42",{extend:Mz.pivot.feature.PivotViewCommon,alias:"feature.pivotview42",tableTpl:{before:function(a){this.pivotViewFeature.setup()},after:function(a){},priority:200},rowTpl:["{%","var me = this.pivotViewFeature;","me.setupRowData(values.record, values.rowIndex, values);","this.nextTpl.applyOut(values, out, parent);","me.resetRenderers();","%}",{priority:200,syncRowHeights:function(d,a){var b,c;d=Ext.fly(d,"syncDest");if(d){b=d.offsetHeight}a=Ext.fly(a,"sycSrc");if(a){c=a.offsetHeight}if(d&&a){if(b>c){Ext.fly(a).setHeight(b)}else{if(c>b){Ext.fly(d).setHeight(c)}}}}}],init:function(b){var c=this,a=c.view;c.callParent(arguments);a.addTableTpl(c.tableTpl).pivotViewFeature=c;a.addRowTpl(Ext.XTemplate.getTpl(c,"rowTpl")).pivotViewFeature=c;a.preserveScrollOnRefresh=true},getViewListeners:function(){var a=this;return Ext.apply(a.callParent(arguments)||{},{refresh:a.onViewReady})},getGridListeners:function(){var a=this;return Ext.apply(a.callParent(arguments)||{},{beforerender:a.onBeforeGridRendered})},onBeforeGridRendered:function(a){var b=this;if(b.isRTL()){b.view.addCellTpl(Ext.XTemplate.getTpl(b,"rtlCellTpl"))}else{b.view.addCellTpl(Ext.XTemplate.getTpl(b,"cellTpl"))}if(b.view.bufferedRenderer&&Ext.isFunction(b.view.bufferedRenderer.onRangeFetched)){b.view.bufferedRenderer.onRangeFetched=Ext.Function.createSequence(b.view.bufferedRenderer.onRangeFetched,function(){b.onViewReady()})}},onViewReady:function(){var a=this;if(a.gridMaster&&a.gridMaster.syncRowHeights&&a.lockingPartner&&a.view.bufferedRenderer){a.gridMaster.syncRowHeights()}},vetoEvent:function(a,c,d,b){if(b.type!=="mouseover"&&b.type!=="mouseout"&&b.type!=="mouseenter"&&b.type!=="mouseleave"&&b.getTarget(this.eventSelector)){return false}},setupRowData:function(b,a,f){var d=this,e=d.dataSource.storeInfo[b.internalId],c=e?e.rendererParams:{};f.rowClasses.length=0;Ext.Array.insert(f.rowClasses,0,e?e.rowClasses:[]);d.setRenderers(c)}});Ext.define("overrides.util.Format",{override:"Ext.util.Format",attributes:function(b){if(typeof b==="object"){var a=[],c;for(c in b){a.push(c,'="',c==="style"?Ext.DomHelper.generateStyles(b[c]):Ext.htmlEncode(b[c]),'"')}b=a.join("")}return b||""}});Ext.define("Mz.pivot.feature.PivotView41",{extend:Mz.pivot.feature.PivotViewCommon,alias:"feature.pivotview41",rowTpl:["{%",'var dataRowCls = values.recordIndex === -1 ? "" : " '+Ext.baseCSSPrefix+'grid-data-row";',"%}",'<tr role="row" {[values.rowId ? ("id=\\"" + values.rowId + "\\"") : ""]} ','data-boundView="{view.id}" ','data-recordId="{record.internalId}" ','data-recordIndex="{recordIndex}" ','class="{[values.itemClasses.join(" ")]} {[values.rowClasses.join(" ")]}{[dataRowCls]}" ','{rowAttr:attributes} tabIndex="-1">','<tpl for="columns">{%',"this.getPivotFeature().renderCell(values, parent.record, parent.recordIndex, xindex - 1, out, parent)","%}","</tpl>","</tr>",{priority:0}],cellValues:null,init:function(a){var b=this;b.callParent(arguments);b.cellValues={classes:[Ext.baseCSSPrefix+"grid-cell "+Ext.baseCSSPrefix+"grid-td"]};b.view.preserveScrollOnRefresh=true},getFragmentTpl:function(){var a=this;return{getPivotFeature:function(){return a}}},getMetaRowTplFragments:function(){return{isRow:this.isRow,closeRow:this.closeRow}},isRow:function(){return"{% this.getPivotFeature().renderGroups(out); %}<tpl if=\"typeof rows === 'undefined'\">"},closeRow:function(){return"</tpl>"},mutateMetaRowTpl:function(a){a.unshift("{[this.isRow()]}");a.push("{[this.closeRow()]}")},collectData:function(b,a,f,e,d){var c=this;if(c.gridMaster&&c.gridMaster.syncRowHeights&&!c.gridMaster.hasMyInterceptor){c.gridMaster.syncRowHeights=Ext.Function.createInterceptor(c.gridMaster.syncRowHeights,c.syncGroupHeaders());c.gridMaster.hasMyInterceptor=true}c.setup();d.rows=[null];return d},renderGroups:function(a){var b=this;b.gridMaster.store.each(function(c){b.renderRow(c,a)})},syncGroupHeaders:function(){var a=this;return function(){var f=this,e,b=0,d,c,g,j,h;d=f.lockedGrid.getView();c=f.normalGrid.getView();g=d.el.query("tr:any("+a.summaryRowSelector+"|"+a.grandSummaryRowSelector+")");j=c.el.query("tr:any("+a.summaryRowSelector+"|"+a.grandSummaryRowSelector+")");e=g.length;if(g.length==j.length){for(;b<e;b++){Ext.fly(j[b]).setHeight(g[b].offsetHeight)}}}},setup:function(){var a=this;a.columns=a.view.getGridColumns();if(Ext.XTemplate.getTpl){a.pivotRowTpl=Ext.XTemplate.getTpl(a,"rowTpl");a.pivotCellTpl=Ext.XTemplate.getTpl(a,"cellTpl")}else{a.pivotRowTpl=new Ext.XTemplate(a.rowTpl);a.pivotCellTpl=new Ext.XTemplate(a.cellTpl)}},getRecord:function(a){var b=Ext.getDom(a).getAttribute("data-recordid");return this.gridMaster.store.data.getByKey(b)},renderRow:function(a,e){var f=this,d=f.pivotRowTpl,b,g=f.dataSource.storeInfo[a.internalId],c=g?g.rendererParams:{};b={view:f.view,record:a,rowStyle:"",rowClasses:[],itemClasses:Ext.clone(g?g.rowClasses||[]:[]),recordIndex:f.gridMaster.store.indexOf(a),rowId:f.getRowId(a),columns:f.columns};if(Ext.Array.indexOf(b.itemClasses,f.rowCls)<0){b.itemClasses.push(f.rowCls)}d.getPivotFeature=function(){return f};f.setRenderers(c);d.applyOut(b,e);f.resetRenderers()},renderCell:function(c,f,e,h,d){var j=this,g=j.grid.selModel,i=j.cellValues,b=i.classes,a=f.data[c.dataIndex],l=j.pivotCellTpl,m,k;i.record=f;i.column=c;i.recordIndex=e;i.columnIndex=h;i.cellIndex=h;i.align=c.align;i.tdCls=c.tdCls;i.innerCls=c.innerCls;i.style=i.tdAttr="";i.unselectableAttr=j.grid.enableTextSelection?"":'unselectable="on"';if(c.renderer&&c.renderer.call){m=c.renderer.call(c.scope||j.ownerCt,a,i,f,e,h,j.dataSource,j);if(i.css){f.cssWarning=true;i.tdCls+=" "+i.css;delete i.css}}else{m=a}i.value=(m==null||m==="")?"&#160;":m;b[1]=Ext.baseCSSPrefix+"grid-cell-"+c.getItemId();k=2;if(c.tdCls){b[k++]=c.tdCls}if(j.markDirty&&f.isModified(c.dataIndex)){b[k++]=j.dirtyCls}if(c.isFirstVisible){b[k++]=j.grid.firstCls}if(c.isLastVisible){b[k++]=j.grid.lastCls}if(!j.enableTextSelection){b[k++]=Ext.baseCSSPrefix+"unselectable"}b[k++]=i.tdCls;if(g&&g.isCellSelected&&g.isCellSelected(j,e,h)){b[k++]=(j.grid.selectedCellCls)}b.length=k;i.tdCls=b.join(" ");l.applyOut(i,d);i.column=null}});Ext.define("Mz.pivot.Grid",{extend:Ext.grid.Panel,alternateClassName:"Mz.pivot.Table",alias:"widget.mzpivotgrid",subGridXType:"gridpanel",debugMode:false,matrixConfig:null,enableLoadMask:true,enableLocking:false,columnLines:true,viewLayoutType:"outline",rowSubTotalsPosition:"first",rowGrandTotalsPosition:"last",colSubTotalsPosition:"last",colGrandTotalsPosition:"last",textTotalTpl:"Total ({name})",textGrandTotalTpl:"Grand total",leftAxis:null,topAxis:null,aggregate:null,clsGroupTotal:Ext.baseCSSPrefix+"grid-group-total",clsGrandTotal:Ext.baseCSSPrefix+"grid-grand-total",startRowGroupsCollapsed:true,startColGroupsCollapsed:true,showZeroAsBlank:false,stateEvents:["pivotgroupexpand","pivotgroupcollapse","pivotdone"],initComponent:function(){var a=this;a.columns=[];a.preInitialize();a.callParent(arguments);a.postInitialize()},preInitialize:function(){var d=this,b=Ext.getVersion("extjs"),c={id:"group",ftype:"",summaryRowCls:d.clsGroupTotal,grandSummaryRowCls:d.clsGrandTotal},a;d.features=[];if(b.match("4.1")){a="pivotview41"}else{if(b.match("4.2")){a="pivotview42"}else{if(b.isGreaterThanOrEqual&&b.isGreaterThanOrEqual(5)){a="pivotview50"}}}if(a){c.ftype=a;d.features.push(c)}if(d.store){d.originalStore=d.store}d.store=Ext.create("Ext.data.ArrayStore",{fields:[]});d.enableColumnMove=false;d.delayedTask=new Ext.util.DelayedTask(d.refreshView,d)},postInitialize:function(){var c=this,a={},b={headerclick:c.onHeaderClick,scope:c,destroyable:true};if(c.enableLocking){c.lockedHeaderCtListeners=c.getView().lockedView.getHeaderCt().on(b);c.headerCtListeners=c.getView().normalView.getHeaderCt().on(b)}else{c.headerCtListeners=c.getView().getHeaderCt().on(b)}if(!Ext.getVersion("extjs").match(5)){c.addEvents("pivotstart","pivotprogress","pivotdone","pivotmodelbuilt","pivotcolumnsbuilt","pivotrecordbuilt","pivotbuildtotals","pivotstorebuilt","pivotgroupexpand","pivotgroupcollapse","pivotgroupclick","pivotgroupdblclick","pivotgroupcontextmenu","pivotgroupcellclick","pivotgroupcelldblclick","pivotgroupcellcontextmenu","pivotitemclick","pivotitemdblclick","pivotitemcontextmenu","pivotitemcellclick","pivotitemcelldblclick","pivotitemcellcontextmenu","pivottotalclick","pivottotaldblclick","pivottotalcontextmenu","pivottotalcellclick","pivottotalcelldblclick","pivottotalcellcontextmenu")}Ext.apply(a,{leftAxis:c.leftAxis,topAxis:c.topAxis,aggregate:c.aggregate,showZeroAsBlank:c.showZeroAsBlank,textTotalTpl:c.textTotalTpl,textGrandTotalTpl:c.textGrandTotalTpl,viewLayoutType:c.viewLayoutType,rowSubTotalsPosition:c.rowSubTotalsPosition,rowGrandTotalsPosition:c.rowGrandTotalsPosition,colSubTotalsPosition:c.colSubTotalsPosition,colGrandTotalsPosition:c.colGrandTotalsPosition});Ext.applyIf(a,c.matrixConfig||{});Ext.applyIf(a,{mztype:"local"});if(a.mztype=="local"&&c.originalStore){Ext.applyIf(a,{store:c.originalStore})}c.matrix=Ext.createByAlias("pivotmatrix."+a.mztype,a);c.matrixListeners=c.matrix.on({cleardata:c.onMatrixClearData,start:c.onMatrixProcessStart,progress:c.onMatrixProcessProgress,done:c.onMatrixDataReady,beforeupdate:c.onMatrixBeforeUpdate,afterupdate:c.onMatrixAfterUpdate,scope:c,destroyable:true});c.matrixRelayedListeners=c.relayEvents(c.matrix,["start","progress","done","modelbuilt","columnsbuilt","recordbuilt","buildtotals","storebuilt"],"pivot")},destroy:function(){var a=this;a.delayedTask.cancel();Ext.destroy(a.matrixRelayedListeners,a.matrixListeners,a.headerCtListeners,a.lockedHeaderCtListeners);Ext.destroy(a.matrix,a.delayedTask,a.originalStore);a.callParent()},afterRender:function(){var a=this;a.reconfigurePivot();a.callParent(arguments)},refreshView:function(){var c=this,a,b;if(c.scheduledReconfigure===true){c.scheduledReconfigure=false;b=c.getMatrix().getColumnHeaders();c.preparePivotColumns(b);c.restorePivotColumnsState(b);c.reconfigure(undefined,b)}c.store.fireEvent("pivotstoreremodel",c)},onMatrixClearData:function(){var a=this;a.store.removeAll(true);if(!a.expandedItemsState){a.lastColumnsState=null}},onMatrixProcessStart:function(){var a=this;a.startTime=Ext.Date.now();if(a.debugMode){Ext.log("Matrix process started")}if(a.enableLoadMask){a.setLoading(true)}},onMatrixProcessProgress:function(a,b,e){var d=this,f,c=((b||0.1)*100)/(e||0.1);if(d.loadMask){if(d.loadMask.msgTextEl){f=d.loadMask.msgTextEl}else{if(d.loadMask.msgEl){f=d.loadMask.msgEl}}if(f){f.update(Ext.util.Format.number(c,"0")+"%")}}},onMatrixBeforeUpdate:function(){this.store.suspendEvents()},onMatrixAfterUpdate:function(){var a=this;a.store.resumeEvents();a.store.fireEvent("pivotstoreremodel")},onMatrixDataReady:function(){var b=this,c=b.matrix.getColumnHeaders(),a=false;if(b.enableLoadMask){b.setLoading(false)}if(b.expandedItemsState){b.matrix.leftAxis.items.each(function(d){if(Ext.Array.indexOf(b.expandedItemsState.rows,d.key)>=0){d.expanded=true;a=true}});b.matrix.topAxis.items.each(function(d){if(Ext.Array.indexOf(b.expandedItemsState.cols,d.key)>=0){d.expanded=true;a=true}});if(a){c=b.matrix.getColumnHeaders(),delete b.expandedItemsState}}else{b.doExpandCollapseTree(b.matrix.leftAxis.getTree(),!b.startRowGroupsCollapsed);b.doExpandCollapseTree(b.matrix.topAxis.getTree(),!b.startColGroupsCollapsed);c=b.matrix.getColumnHeaders()}b.preparePivotColumns(c);b.restorePivotColumnsState(c);b.reconfigure(undefined,c);b.store.fireEvent("pivotstoreremodel",b);if(b.debugMode){Ext.log("Matrix process ended in "+(Ext.Date.now()-b.startTime)+"ms")}},preparePivotColumns:function(b){var f=this,e={menuDisabled:true,sortable:false,lockable:false},d=b.length,a,c;for(a=0;a<d;a++){c=b[a];c.cls=c.cls||"";Ext.apply(c,e);if(c.leftAxis){c.locked=f.enableLocking}if(c.subTotal){c.cls=c.tdCls=f.clsGroupTotal}if(c.grandTotal){c.cls=c.tdCls=f.clsGrandTotal}if(!c.xexpanded){c.cls+=" "+Ext.baseCSSPrefix+"grid-row-collapsed"}if(c.xcollapsible){c.text=Ext.String.format('<span class="'+Ext.baseCSSPrefix+'grid-row-expander" style="padding-left: 13px">{0}</span>',c.text)}if(Ext.isEmpty(c.columns)){if(c.dimension){c.renderer=(c.dimension&&!c.leftAxis)?c.dimension.renderer:false;c.align=c.dimension.align;if(c.dimension.flex>0){c.flex=c.dimension.flex}else{c.width=c.dimension.width}}}else{f.preparePivotColumns(c.columns)}}},reconfigurePivot:function(a){var d=this,c=Ext.clone(d.getStateProperties()),b;c.push("startRowGroupsCollapsed","startColGroupsCollapsed","showZeroAsBlank");a=a||{};for(b=0;b<c.length;b++){if(!a.hasOwnProperty(c[b])){if(d[c[b]]){a[c[b]]=d[c[b]]}}else{d[c[b]]=a[c[b]]}}d.getMatrix().reconfigure(a)},getMatrix:function(){return this.matrix},doExpandCollapseTree:function(a,b){var c;for(c=0;c<a.length;c++){a[c].expanded=b;if(a[c].children){this.doExpandCollapseTree(a[c].children,b)}}},doExpandCollapse:function(b,a,e){var d=this,c;if(!d.matrix){return}c=(b=="row"?d.matrix.leftAxis:d.matrix.topAxis)["findTreeElement"]("key",a);if(!c){return}c.node.expanded=Ext.isDefined(e)?e:!c.node.expanded;if(b=="col"){d.scheduledReconfigure=true}d.refreshView();d.fireEvent((c.node.expanded?"pivotgroupexpand":"pivotgroupcollapse"),d,b,c.node)},expandRow:function(a){this.doExpandCollapse("row",a,true)},collapseRow:function(a){this.doExpandCollapse("row",a,false)},expandCol:function(a){this.doExpandCollapse("col",a,true)},collapseCol:function(a){this.doExpandCollapse("col",a,false)},expandAll:function(){var a=this;a.expandAllColumns();a.expandAllRows()},expandAllRows:function(){var a=this;if(!a.getMatrix()){return}a.doExpandCollapseTree(a.getMatrix().leftAxis.getTree(),true);a.delayedTask.delay(10)},expandAllColumns:function(){var a=this;if(!a.getMatrix()){return}a.doExpandCollapseTree(a.getMatrix().topAxis.getTree(),true);a.scheduledReconfigure=true;a.delayedTask.delay(10)},collapseAll:function(){var a=this;a.collapseAllRows();a.collapseAllColumns()},collapseAllRows:function(){var a=this;if(!a.getMatrix()){return}a.doExpandCollapseTree(a.getMatrix().leftAxis.getTree(),false);a.delayedTask.delay(10)},collapseAllColumns:function(){var a=this;if(!a.getMatrix()){return}a.doExpandCollapseTree(a.getMatrix().topAxis.getTree(),false);a.scheduledReconfigure=true;a.delayedTask.delay(10)},getStore:function(){var b=this,a=b.getMatrix();return((a instanceof Mz.aggregate.matrix.Local)?a.store:b.originalStore)||b.store},getPivotStore:function(){return this.store},onHeaderClick:function(c,f,h){var g=this,b,d,a=(f.sortState?(f.sortState=="ASC"?"DESC":"ASC"):"ASC");if(!f.xexpandable){if(h){h.stopEvent()}if((f.leftAxis||f.topAxis)&&!Ext.isEmpty(f.dataIndex)){if(g.getMatrix().leftAxis.sortTreeByField(f.dataIndex,a)){g.refreshView();if(Ext.getVersion("extjs").match(5)){f.setSortState(new Ext.util.Sorter({direction:a,property:"dummy"}));f.sortState=a}else{f.setSortState(a,false,true)}}}return false}g.doExpandCollapse("col",f.key);if(h){h.stopEvent()}},getStateProperties:function(){return["viewLayoutType","rowSubTotalsPosition","rowGrandTotalsPosition","colSubTotalsPosition","colGrandTotalsPosition","aggregate","leftAxis","topAxis"]},applyState:function(d){var c=this,b=c.getStateProperties(),a;for(a=0;a<b.length;a++){if(d[b[a]]){c[b[a]]=d[b[a]]}}if(d.expandedItems){c.expandedItemsState=d.expandedItems}c.lastColumnsState=d.pivotcolumns||{};if(c.rendered){c.reconfigurePivot()}},getState:function(){var c=this,d={},b=c.getStateProperties(),a;for(a=0;a<b.length;a++){d[b[a]]=c[b[a]]}d.expandedItems={cols:[],rows:[]};c.matrix.leftAxis.items.each(function(e){if(e.expanded){d.expandedItems["rows"].push(e.key)}});c.matrix.topAxis.items.each(function(e){if(e.expanded){d.expandedItems["cols"].push(e.key)}});c.matrix.leftAxis.dimensions.each(function(f,e){d.leftAxis[e]["id"]=f.getId()});d.pivotcolumns=c.getPivotColumnsState();return d},getPivotColumnsState:function(){var b=this,a,c;if(!b.lastColumnsState){c=b.getDataIndexColumns(b.getMatrix().getColumnHeaders());b.lastColumnsState={};for(a=0;a<c.length;a++){if(c[a].dataIndex){b.lastColumnsState[c[a].dataIndex]={width:c[a].width,flex:c[a].flex||0}}}}c=b.getView().getGridColumns();for(a=0;a<c.length;a++){if(c[a].dataIndex){b.lastColumnsState[c[a].dataIndex]={width:c[a].rendered?c[a].getWidth():c[a].width,flex:c[a].flex||0}}}return b.lastColumnsState},getDataIndexColumns:function(b){var c=[],a;for(a=0;a<b.length;a++){if(b[a].dataIndex){c.push(b[a].dataIndex)}else{if(Ext.isArray(b[a].columns)){c=Ext.Array.merge(c,this.getDataIndexColumns(b[a].columns))}}}return c},restorePivotColumnsState:function(b){var c=this,d=c.getPivotColumnsState(),a;a=function(f){var g,e;if(!f){return}for(e=0;e<f.length;e++){g=d[f[e].dataIndex];if(g){if(g.flex){f[e].flex=g.flex}else{if(g.width){f[e].width=g.width}}}a(f[e].columns)}};a(b)}});Ext.define("Mz.pivot.dataexport.Formatter",{onlyExpandedNodes:false,matrix:null,config:null,data:null,constructor:function(a){var b=this;a=a||{};b.matrix=a.matrix;b.onlyExpandedNodes=a.onlyExpandedNodes;b.config=a.config;b.data=b.prepareData()},format:Ext.emptyFn,prepareData:function(){var f=this,c=f.matrix,g,e,h,b,d,a;if(!f.onlyExpandedNodes){f.setColumnsExpanded(c.topAxis.getTree(),true)}e=Ext.clone(c.getColumnHeaders());h=f.getColumnHeaders(e,0);a=f.getDataIndexColumns(e);if(!f.onlyExpandedNodes){f.setColumnsExpanded(c.topAxis.getTree())}g=f.extractGroups(c.leftAxis.getTree(),a);Ext.apply(g,{columns:h,summary:[],summaryText:c.textGrandTotalTpl});b=c.preparePivotStoreRecordData({key:c.grandTotalKey});for(d=0;d<a.length;d++){g.summary.push(b[a[d]]||"")}return g},setColumnsExpanded:function(b,a){for(var c=0;c<b.length;c++){if(Ext.isDefined(a)){b[c].backupExpanded=b[c].expanded;b[c].expanded=a}else{b[c].expanded=b[c].backupExpanded;b[c].backupExpanded=null}if(b[c].children){this.setColumnsExpanded(b[c].children,a)}}},getColumnHeaders:function(b,e){var d=[],a,c;for(a=0;a<b.length;a++){c={text:b[a].text,level:e};if(b[a].columns){c.columns=this.getColumnHeaders(b[a].columns,e+1)}d.push(c)}return d},getDataIndexColumns:function(b){var c=[],a;for(a=0;a<b.length;a++){if(b[a].dataIndex){c.push(b[a].dataIndex)}else{if(Ext.isArray(b[a].columns)){c=Ext.Array.merge(c,this.getDataIndexColumns(b[a].columns))}}}return c},extractGroups:function(f,a){var g=this,h={},c,b,e,k,l,d;for(c=0;c<f.length;c++){k=f[c];if(k.record){h.rows=h.rows||[];l=[];for(b=0;b<a.length;b++){l.push(k.record.get(a[b])||"")}h.rows.push(l)}else{if(k.children){h.groups=h.groups||[];l={};e=g.onlyExpandedNodes?k.expanded:true;if(e){l=g.extractGroups(k.children,a)}Ext.apply(l,{summary:[],summaryText:k.getTextTotal(),text:k.name});d=g.matrix.preparePivotStoreRecordData(k);for(b=0;b<a.length;b++){l.summary.push(d[a[b]]||"")}h.groups.push(l)}}}return h}});Ext.define("Mz.pivot.dataexport.excel.Cell",{constructor:function(a){Ext.applyIf(a,{type:"String",style:"Default"});Ext.apply(this,a)},render:function(){return this.tpl.apply(this)},tpl:new Ext.XTemplate('<ss:Cell ss:MergeAcross="{merge}" <tpl if="style">ss:StyleID="{style}"</tpl>>','<ss:Data ss:Type="{type}">','<tpl switch="type">','<tpl case="String">',"{[this.formatString(values.value)]}","<tpl default>","{value}","</tpl>","</ss:Data>","</ss:Cell>",{formatString:Ext.String.htmlEncode})});Ext.define("Mz.pivot.dataexport.excel.Style",{constructor:function(a){var b=this;a=a||{};Ext.apply(b,a,{parentStyle:"",attributes:[]});if(!Ext.isDefined(b.id)){throw new Error("An ID must be provided to Style")}b.preparePropertyStrings()},preparePropertyStrings:function(){var a=this;Ext.each(a.attributes,function(b,c){this.attributes[c].propertiesString=this.buildPropertyString(b);this.attributes[c].children=b.children||[];Ext.each(b.children,function(e,d){this.attributes[c].children[d].propertiesString=this.buildPropertyString(e)},this)},a)},buildPropertyString:function(c){var b=this,a="";Ext.each(c.properties||[],function(d){a+=Ext.String.format('ss:{0}="{1}" ',d.name,d.value)},b);return a},render:function(){var a=this;return a.tpl.apply(a)},tpl:new Ext.XTemplate('<tpl if="parentStyle.length == 0">','<ss:Style ss:ID="{id}">',"</tpl>",'<tpl if="parentStyle.length != 0">','<ss:Style ss:ID="{id}" ss:Parent="{parentStyle}">',"</tpl>",'<tpl for="attributes">','<tpl if="children.length == 0">',"<ss:{name} {propertiesString} />","</tpl>",'<tpl if="children.length &gt; 0">',"<ss:{name} {propertiesString}>",'<tpl for="children">',"<ss:{name} {propertiesString} />","</tpl>","</ss:{name}>","</tpl>","</tpl>","</ss:Style>")});Ext.define("Mz.pivot.dataexport.excel.Workbase",{constructor:function(a){var b=this;a=Ext.clone(a||{});Ext.apply(b,a,{title:"Workbook",cellFontName:"Arial",cellFontSize:"10",cellBorderColor:"#E4E4E4",cellFillColor:"",titleFontSize:"14",titleFillColor:"",dateFormat:"Short Date",numberFormat:"Standard",styles:[],compiledStyles:[]})},addStyle:function(a){var c=this,b=Ext.create("Mz.pivot.dataexport.excel.Style",a||{});c.styles.push(b);return b},getInteriorStyle:function(b){var a={name:"Interior"};if(!Ext.isEmpty(b)){a.properties=[{name:"Pattern",value:"Solid"},{name:"Color",value:b}]}return a}});Ext.define("Mz.pivot.dataexport.excel.Worksheet",{extend:Mz.pivot.dataexport.excel.Workbase,constructor:function(a){var b=this;b.callParent(arguments);Ext.applyIf(b,{showTitle:true,groupHeaderFontSize:"10",groupHeaderFillColor:"#D8D8D8",groupFooterFontSize:"10",groupFooterFillColor:"#BFBFBF",columns:b.data?b.data.columns||[]:[]});if(b.showTitle){b.addTitleStyle()}},worksheetTpl:new Ext.XTemplate('<ss:Worksheet ss:Name="{title}">',"<ss:Names>",'<ss:NamedRange ss:Name="Print_Titles" ss:RefersTo="=\'{title}\'!R1:R2" />',"</ss:Names>",'<ss:Table x:FullRows="1" x:FullColumns="1" ss:ExpandedColumnCount="{colCount}" ss:ExpandedRowCount="{rowCount}">',"{columns}",'<tpl if="showTitle">','<ss:Row ss:Height="38">','<ss:Cell ss:StyleID="Title" ss:MergeAcross="{colCount - 1}">','<ss:Data ss:Type="String">{title}</ss:Data>','<ss:NamedCell ss:Name="Print_Titles" />',"</ss:Cell>","</ss:Row>","</tpl>","{header}","{rows}","</ss:Table>","<x:WorksheetOptions>","<x:PageSetup>",'<x:Layout x:CenterHorizontal="1" x:Orientation="Landscape" />','<x:Footer x:Data="Page &amp;P of &amp;N" x:Margin="0.5" />','<x:PageMargins x:Top="0.5" x:Right="0.5" x:Left="0.5" x:Bottom="0.8" />',"</x:PageSetup>","<x:FitToPage />","<x:Print>","<x:PrintErrors>Blank</x:PrintErrors>","<x:FitWidth>1</x:FitWidth>","<x:FitHeight>32767</x:FitHeight>","<x:ValidPrinterInfo />","<x:VerticalResolution>600</x:VerticalResolution>","</x:Print>","<x:Selected />","<x:DoNotDisplayGridlines />","<x:ProtectObjects>False</x:ProtectObjects>","<x:ProtectScenarios>False</x:ProtectScenarios>","</x:WorksheetOptions>","</ss:Worksheet>"),render:function(){var a=this;a.fixColumns(a.data.columns,a.getColDepth(a.data.columns,-1));var b=a.buildRows();return a.worksheetTpl.apply({header:a.buildHeader(),columns:"",rows:b.join(""),colCount:a.getColCount(a.data.columns),rowCount:b.length+a.getColDepth(a.data.columns,1),title:a.title,showTitle:a.showTitle})},getColCount:function(b){var d=this,c=0;if(!b){return c}for(var a=0;a<b.length;a++){if(!b[a].columns){c+=1}else{c+=d.getColCount(b[a].columns)}}return c},getColDepth:function(c,e){var d=this,a=0;if(!c){return e}for(var b=0;b<c.length;b++){a=Math.max(a,d.getColDepth(c[b].columns,e+1))}return a},fixColumns:function(c,e){var d=this,a;if(!c){return}for(var b=0;b<c.length;b++){a=c[b];if(!a.columns&&e>a.level){a.columns=[];a.columns.push({text:"",level:a.level+1})}d.fixColumns(a.columns,e)}},buildColumns:function(){var a=this,b=[];Ext.each(a.columns,function(c){b.push(this.buildColumn())},a);return b},buildColumn:function(a){return String.format('<ss:Column ss:AutoFitWidth="1" ss:Width="{0}" />',a||164)},buildRows:function(){var e=this,f=[],d,b=e.data.columns.length>0?e.getColCount(e.data.columns[0].columns):0,g=e.getColCount(e.data.columns),a=Ext.isDefined(e.data.groups)?e.data.groups:Ext.Array.from(e.data);e.buildSummaryRows(a,f,g,1);if(Ext.isDefined(e.data.groups)&&e.data.summary.length>0){e.addGroupLevelStyle(1);d=[];d.push(e.buildCell(e.data.summaryText,0,"SummaryFooter1").render());for(var c=1;c<e.data.summary.length;c++){d.push(e.buildCell(e.data.summary[c],0,"SummaryFooter1").render())}f.push(Ext.String.format("<ss:Row>{0}</ss:Row>",d.join("")))}return f},buildSummaryRows:function(c,l,a,b){var h=this,f,k;if(!c){return}for(var e=0;e<c.length;e++){h.addGroupLevelStyle(b);f=c[e];l.push(Ext.String.format("<ss:Row>{0}</ss:Row>",h.buildCell(f.text,a-1,"SummaryHeader"+b,"String").render()));h.buildSummaryRows(f.groups,l,a,b+1);h.buildGroupRows(f.rows,l);if(f.summary.length>0){k=[];k.push(h.buildCell(f.summaryText,0,"SummaryFooter"+b,"String").render());for(var d=1;d<f.summary.length;d++){k.push(h.buildCell(f.summary[d],0,"SummaryFooter"+b).render())}l.push(Ext.String.format("<ss:Row>{0}</ss:Row>",k.join("")))}}},buildGroupRows:function(b,h){var g=this,a,d;if(!b){return}for(var e=0;e<b.length;e++){a=b[e];d=[];var f=e%2==0?"even":"odd";for(var c=0;c<a.length;c++){d.push(g.buildCell(a[c],0,g.hasDefaultStyle?"Default":"").render())}h.push(Ext.String.format("<ss:Row>{0}</ss:Row>",d.join("")))}},buildHeader:function(){var d=this,b=[],a={},c="";d.buildHeaderRows(d.data.columns,a);Ext.Object.each(a,function(e,g,f){b.push(Ext.String.format('<ss:Row ss:AutoFitHeight="1">{0}</ss:Row>',g.join("")))});return b.join("")},buildHeaderRows:function(d,a){var g=this,b,f,e;if(!d){return}for(var c=0;c<d.length;c++){b=d[c];f=g.getColCount(b.columns);a["s"+b.level]=a["s"+b.level]||[];if(f===0||f===1){e=Ext.String.format('<ss:Cell ss:StyleID="Header"><ss:Data ss:Type="String">{0}</ss:Data><ss:NamedCell ss:Name="Print_Titles" /></ss:Cell>',b.text)}else{e=Ext.String.format('<ss:Cell ss:MergeAcross="{0}" ss:StyleID="Header"><ss:Data ss:Type="String">{1}</ss:Data><ss:NamedCell ss:Name="Print_Titles" /></ss:Cell>',f-1,b.text)}a["s"+b.level].push(e);g.buildHeaderRows(b.columns,a)}},buildCell:function(d,e,b,a){var c=this;if(!a){a=c.getExcelValueType(d)}if(a=="DateTime"){d=Ext.Date.format(d,"Y-m-d\\TH:i:s")}if(!Ext.isEmpty(b)){b+=(a!="String")?a:""}return Ext.create("Mz.pivot.dataexport.excel.Cell",{value:d,type:a,merge:e,style:b})},getExcelValueType:function(a){return Ext.isNumeric(a)?"Number":(Ext.isDate(a)?"DateTime":"String")},addTitleStyle:function(){var a=this;a.addStyle({id:"Title",attributes:[{name:"Borders"},{name:"Font",properties:[{name:"Bold",value:"1"},{name:"Size",value:a.titleFontSize}]},{name:"NumberFormat",properties:[{name:"Format",value:"@"}]},a.getInteriorStyle(a.titleFillColor),{name:"Alignment",properties:[{name:"WrapText",value:"1"},{name:"Horizontal",value:"Center"},{name:"Vertical",value:"Center"}]}]})},addSummaryStyle:function(a,f,d,e){var c=this,b=a+f;c.addStyle({id:b,attributes:[{name:"Font",properties:[{name:"Bold",value:"1"},{name:"Size",value:d}]},c.getInteriorStyle(e),{name:"Alignment",properties:[{name:"Indent",value:f-1},{name:"Vertical",value:"Center"}]}]});c.addStyle({id:b+"Number",parentStyle:b,attributes:[{name:"NumberFormat",properties:[{name:"Format",value:c.numberFormat}]},{name:"Alignment",properties:[{name:"Horizontal",value:"Right"}]}]});c.addStyle({id:b+"DateTime",parentStyle:b,attributes:[{name:"NumberFormat",properties:[{name:"Format",value:c.dateFormat}]},{name:"Alignment",properties:[{name:"Horizontal",value:"Right"}]}]});c.addStyle({id:b+"String",parentStyle:b,attributes:[{name:"Alignment",properties:[{name:"Horizontal",value:"Left"}]}]})},addGroupLevelStyle:function(c){var b=this,a;a=Ext.Array.pluck(b.styles,"id");if(Ext.Array.indexOf(a,"SummaryHeader"+c)<0){b.addSummaryStyle("SummaryHeader",c,b.groupHeaderFontSize,b.groupHeaderFillColor);b.addSummaryStyle("SummaryFooter",c,b.groupFooterFontSize,b.groupFooterFillColor)}}});Ext.define("Mz.pivot.dataexport.excel.Workbook",{extend:Mz.pivot.dataexport.excel.Workbase,constructor:function(a){var b=this;b.callParent(arguments);Ext.applyIf(b,{hasDefaultStyle:true,headerFontSize:"10",headerFillColor:"#BFBFBF",windowHeight:9000,windowWidth:50000,protectStructure:false,protectWindows:false,worksheets:[],compiledWorksheets:[]});if(b.hasDefaultStyle){b.addDefaultStyle()}b.addHeaderStyle()},render:function(){var a=this;a.compileWorksheets();a.joinedWorksheets=a.compiledWorksheets.join("");a.compileStyles();a.joinedCompiledStyles=a.compiledStyles.join("");return a.tpl.apply(a)},addWorksheet:function(e,b){var d=this,a,c,f;f=Ext.create("Mz.pivot.dataexport.excel.Worksheet",Ext.apply({data:e,hasDefaultStyle:d.hasDefaultStyle,showTitle:d.showTitle},b));d.worksheets.push(f);return f},compileStyles:function(){var a=this;a.compiledStyles=[];Ext.each(a.worksheets,function(b){a.styles=Ext.Array.merge(a.styles,b.styles)},a);Ext.each(a.styles,function(b){a.compiledStyles.push(b.render())},a);return a.compiledStyles},compileWorksheets:function(){var a=this;a.compiledWorksheets=[];Ext.each(a.worksheets,function(b){a.compiledWorksheets.push(b.render())},a);return a.compiledWorksheets},tpl:new Ext.XTemplate('<?xml version="1.0" encoding="utf-8"?>','<ss:Workbook xmlns:ss="urn:schemas-microsoft-com:office:spreadsheet" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns:o="urn:schemas-microsoft-com:office:office">',"<o:DocumentProperties>","<o:Title>{title}</o:Title>","</o:DocumentProperties>","<ss:ExcelWorkbook>","<ss:WindowHeight>{windowHeight}</ss:WindowHeight>","<ss:WindowWidth>{windowWidth}</ss:WindowWidth>","<ss:ProtectStructure>{protectStructure}</ss:ProtectStructure>","<ss:ProtectWindows>{protectWindows}</ss:ProtectWindows>","</ss:ExcelWorkbook>","<ss:Styles>","{joinedCompiledStyles}","</ss:Styles>","{joinedWorksheets}","</ss:Workbook>"),addDefaultStyle:function(){var b=this,a=[{name:"Color",value:b.cellBorderColor},{name:"Weight",value:"1"},{name:"LineStyle",value:"Continuous"}];b.addStyle({id:"Default",attributes:[{name:"Alignment",properties:[{name:"Vertical",value:"Top"},{name:"WrapText",value:"1"}]},{name:"Font",properties:[{name:"FontName",value:b.cellFontName},{name:"Size",value:b.cellFontSize}]},b.getInteriorStyle(b.cellFillColor),{name:"NumberFormat"},{name:"Protection"},{name:"Borders",children:[{name:"Border",properties:[{name:"Position",value:"Top"}].concat(a)},{name:"Border",properties:[{name:"Position",value:"Bottom"}].concat(a)},{name:"Border",properties:[{name:"Position",value:"Left"}].concat(a)},{name:"Border",properties:[{name:"Position",value:"Right"}].concat(a)}]}]});b.addStyle({id:"DefaultNumber",parentStyle:"Default",attributes:[{name:"NumberFormat",properties:[{name:"Format",value:b.numberFormat}]},{name:"Alignment",properties:[{name:"Horizontal",value:"Right"}]}]});b.addStyle({id:"DefaultDateTime",parentStyle:"Default",attributes:[{name:"NumberFormat",properties:[{name:"Format",value:b.dateFormat}]},{name:"Alignment",properties:[{name:"Horizontal",value:"Right"}]}]})},addHeaderStyle:function(){var a=this;a.addStyle({id:"Header",attributes:[{name:"Font",properties:[{name:"Bold",value:"1"},{name:"Size",value:a.headerFontSize}]},a.getInteriorStyle(a.headerFillColor),{name:"Alignment",properties:[{name:"WrapText",value:"1"},{name:"Horizontal",value:"Center"}]}]})}});Ext.define("Mz.pivot.dataexport.excel.Formatter",{extend:Mz.pivot.dataexport.Formatter,format:function(){var b=this,a=Ext.create("Mz.pivot.dataexport.excel.Workbook",b.config||{});a.addWorksheet(b.data,b.config||{});return a.render()}});Ext.define("Mz.pivot.plugin.configurator.FilterLabelWindow",{extend:Ext.window.Window,width:400,height:160,modal:true,closeAction:"destroy",titleText:"Label filter ({0})",fieldText:"Show items for which the label",caseSensitiveText:"Case sensitive",initComponent:function(){var b=this,a=[];a=b.filterFields||[];a.push({xtype:"combo",editable:false,queryMode:"local",valueField:"value",store:b.store,name:"type",listeners:{change:function(e,d){var c=(d==Mz.aggregate.filter.Label.TypeBetween||d==Mz.aggregate.filter.Label.TypeNotBetween);this.down("#fValue").setVisible(!c);this.down("#fValue").allowBlank=c;this.down("#fFrom").setVisible(c);this.down("#fFrom").allowBlank=!c;this.down("#fTo").setVisible(c);this.down("#fTo").allowBlank=!c},scope:b}},{itemId:"fValue",xtype:"textfield",margin:"0 0 0 5",name:"value"},{itemId:"fFrom",xtype:"textfield",margin:"0 0 0 5",name:"from"},{itemId:"fTo",xtype:"textfield",margin:"0 0 0 5",name:"to"});Ext.apply(b,{title:Ext.String.format(b.titleText,b.title),layout:"fit",items:[{xtype:"form",bodyPadding:5,items:[{xtype:"hidden",name:"mztype"},{xtype:"fieldcontainer",labelSeparator:"",fieldLabel:b.fieldText,labelAlign:"top",layout:{type:"hbox",align:"stretch"},defaults:{allowBlank:false,flex:1},items:a},{xtype:"checkbox",boxLabel:b.caseSensitiveText,name:"caseSensitive"}]}],buttons:[{text:Ext.Msg.buttonText.ok,handler:b.applyFilter,scope:b},{text:Ext.Msg.buttonText.cancel,handler:b.cancelFilter,scope:b}]});b.callParent(arguments)},applyFilter:function(){var a=this;if(a.down("form").getForm().isValid()){a.fireEvent("filter",a)}},cancelFilter:function(){this.close()}});Ext.define("Mz.pivot.plugin.configurator.Column",{extend:Ext.Component,alias:"widget.mzconfigcolumn",childEls:["textCol","filterCol","sortCol"],renderTpl:'<div id="{id}-configCol" class="'+Ext.baseCSSPrefix+'config-column-inner"><tpl if="isCustomizable"><span id={id}-customCol class="'+Ext.baseCSSPrefix+'config-column-customize"></span></tpl><span id="{id}-textCol" class="'+Ext.baseCSSPrefix+"config-column-text "+Ext.baseCSSPrefix+'column-header-text">{header}{aggregator}</span><span id={id}-sortCol class=""></span><span id={id}-filterCol class=""></span></div>',header:"&#160;",isCustomizable:false,dimension:null,isAgg:false,sumText:"Sum",avgText:"Avg",countText:"Count",minText:"Min",maxText:"Max",groupSumPercentageText:"Group sum percentage",groupCountPercentageText:"Group count percentage",sortAscText:"Sort A to Z",sortDescText:"Sort Z to A",sortClearText:"Disable sorting",clearFilterText:'Clear filter from "{0}"',labelFiltersText:"Label filters",valueFiltersText:"Value filters",equalsText:"Equals...",doesNotEqualText:"Does not equal...",beginsWithText:"Begins with...",doesNotBeginWithText:"Does not begin with...",endsWithText:"Ends with...",doesNotEndWithText:"Does not end with...",containsText:"Contains...",doesNotContainText:"Does not contain...",greaterThanText:"Greater than...",greaterThanOrEqualToText:"Greater than or equal to...",lessThanText:"Less than...",lessThanOrEqualToText:"Less than or equal to...",betweenText:"Between...",notBetweenText:"Not between...",top10Text:"Top 10...",equalsLText:"equals",doesNotEqualLText:"does not equal",beginsWithLText:"begins with",doesNotBeginWithLText:"does not begin with",endsWithLText:"ends with",doesNotEndWithLText:"does not end with",containsLText:"contains",doesNotContainLText:"does not contain",greaterThanLText:"is greater than",greaterThanOrEqualToLText:"is greater than or equal to",lessThanLText:"is less than",lessThanOrEqualToLText:"is less than or equal to",betweenLText:"is between",notBetweenLText:"is not between",top10LText:"Top 10...",topOrderTopText:"Top",topOrderBottomText:"Bottom",topTypeItemsText:"Items",topTypePercentText:"Percent",topTypeSumText:"Sum",ascSortCls:Ext.baseCSSPrefix+"config-column-sort-ASC",descSortCls:Ext.baseCSSPrefix+"config-column-sort-DESC",baseCls:Ext.baseCSSPrefix+"config-column",filteredCls:Ext.baseCSSPrefix+"config-column-filtered",clearFilterIconCls:Ext.baseCSSPrefix+"clearFilterIcon",ascSortIconCls:Ext.baseCSSPrefix+"sortAscIcon",descSortIconCls:Ext.baseCSSPrefix+"sortDescIcon",disableSortIconCls:Ext.baseCSSPrefix+"sortDisableIcon",height:26,initComponent:function(){var a=this;a.callParent(arguments);if(!Ext.getVersion("extjs").match(5)){a.addEvents("sortchange","filterchange")}},destroy:function(){var a=this;delete (a.dimension);Ext.destroy(a.relayers,a.menu);a.callParent(arguments)},show:function(){var a=this;a.callParent()},initRenderData:function(){var a=this;return Ext.apply(a.callParent(arguments),{header:a.dimension.header,aggregator:a.isAgg?" ("+a.dimension.aggregator+")":"",dimension:a.dimension,isCustomizable:a.isCustomizable})},afterRender:function(){var a=this;a.callParent();if(a.isCustomizable){if(a.dimension.sortable){a.addSortCls(a.dimension.direction)}if(a.dimension.filter){a.addFilterCls()}a.mon(a.getTargetEl(),{scope:a,click:a.handleColClick})}},handleColClick:function(c,a){var b=this;if(b.isAgg){b.showAggMenu();c.stopEvent()}else{b.showColMenu()}},handleMenuClick:function(b,c){var a=this,d;a.dimension.aggregator=b.aggregator;if(a.textCol){d=a.textCol.setHtml?"setHtml":"setHTML";a.textCol[d](a.header+" ("+a.dimension.aggregator+")")}a.ownerCt.updateLayout();a.fireEvent("configchange")},addSortCls:function(b){var a=this;if(!a.sortCol){return}if(b==="ASC"){a.sortCol.addCls(a.ascSortCls);a.sortCol.removeCls(a.descSortCls)}else{a.sortCol.addCls(a.descSortCls);a.sortCol.removeCls(a.ascSortCls)}},removeSortCls:function(b){var a=this;if(!a.sortCol){return}if(b==="ASC"){a.sortCol.removeCls(a.ascSortCls)}else{a.sortCol.removeCls(a.descSortCls)}},addFilterCls:function(){var a=this;if(a.filterCol&&!a.filterCol.hasCls(a.filteredCls)){a.filterCol.addCls(a.filteredCls)}},removeFilterCls:function(){var a=this;if(a.filterCol){a.filterCol.removeCls(a.filteredCls)}},serialize:function(){var a=this;return Ext.applyIf({idColumn:a.id},a.initialConfig)},showAggMenu:function(){var a=this,b=a.dimension.aggregator;Ext.destroy(a.menu);a.menu=Ext.create("Ext.menu.Menu",{floating:true,defaults:{handler:a.handleMenuClick,scope:a,xtype:"menucheckitem",group:"aggregator"},items:[{text:a.sumText,aggregator:"sum",checked:b=="sum"},{text:a.avgText,aggregator:"avg",checked:b=="avg"},{text:a.countText,aggregator:"count",checked:b=="count"},{text:a.maxText,aggregator:"max",checked:b=="max"},{text:a.minText,aggregator:"min",checked:b=="min"},{text:a.groupSumPercentageText,aggregator:"groupSumPercentage",checked:b=="groupSumPercentage"},{text:a.groupCountPercentageText,aggregator:"groupCountPercentage",checked:b=="groupCountPercentage"}]});a.menu.showBy(a)},showColMenu:function(){var e=this,b=[],g,f,a,c,d=e.dimension.filter;Ext.destroy(e.menu);b.push({text:e.sortAscText,direction:"ASC",iconCls:e.ascSortIconCls,handler:e.sortMe},{text:e.sortDescText,direction:"DESC",iconCls:e.descSortIconCls,handler:e.sortMe},{text:e.sortClearText,direction:"",disabled:!e.dimension.sortable,iconCls:e.disableSortIconCls,handler:e.sortMe},{xtype:"menuseparator"});a=[{text:e.equalsText,filterType:Mz.aggregate.filter.Label.TypeEquals},{text:e.doesNotEqualText,filterType:Mz.aggregate.filter.Label.TypeDoesNotEqual},{xtype:"menuseparator"},{text:e.greaterThanText,filterType:Mz.aggregate.filter.Label.TypeGreaterThan},{text:e.greaterThanOrEqualToText,filterType:Mz.aggregate.filter.Label.TypeGreaterThanOrEqualTo},{text:e.lessThanText,filterType:Mz.aggregate.filter.Label.TypeLessThan},{text:e.lessThanOrEqualToText,filterType:Mz.aggregate.filter.Label.TypeLessThanOrEqualTo},{xtype:"menuseparator"},{text:e.betweenText,filterType:Mz.aggregate.filter.Label.TypeBetween},{text:e.notBetweenText,filterType:Mz.aggregate.filter.Label.TypeNotBetween}];g=Ext.clone(a);Ext.Array.insert(g,3,[{text:e.beginsWithText,filterType:Mz.aggregate.filter.Label.TypeBeginsWith},{text:e.doesNotBeginWithText,filterType:Mz.aggregate.filter.Label.TypeDoesNotBeginWith},{text:e.endsWithText,filterType:Mz.aggregate.filter.Label.TypeEndsWith},{text:e.doesNotEndWithText,filterType:Mz.aggregate.filter.Label.TypeDoesNotEndWith},{xtype:"menuseparator"},{text:e.containsText,filterType:Mz.aggregate.filter.Label.TypeContains},{text:e.doesNotContainText,filterType:Mz.aggregate.filter.Label.TypeDoesNotContain},{xtype:"menuseparator"}]);for(c=0;c<g.length;c++){g[c]["checked"]=(d&&d.mztype=="label"&&d.type==g[c].filterType)}f=Ext.clone(a);f.push({xtype:"menuseparator"},{text:e.top10Text,filterType:Mz.aggregate.filter.Value.TypeTop10});for(c=0;c<f.length;c++){f[c]["checked"]=(d&&d.mztype=="value"&&d.type==f[c].filterType)}b.push({text:Ext.String.format(e.clearFilterText,e.header),iconCls:e.clearFilterIconCls,disabled:!d,handler:e.onRemoveFilter},{text:e.labelFiltersText,menu:{defaults:{handler:e.onShowFilter,scope:e,xtype:"menucheckitem",group:"filterlabel",mztype:"label"},items:g}},{text:e.valueFiltersText,menu:{defaults:{handler:e.onShowFilter,scope:e,xtype:"menucheckitem",group:"filtervalue",mztype:"value"},items:f}});e.menu=Ext.create("Ext.menu.Menu",{floating:true,defaults:{scope:e},items:b});e.menu.showBy(e)},sortMe:function(a){var b=this;if(Ext.isEmpty(a.direction)){b.dimension.sortable=false;b.removeSortCls(b.dimension.direction)}else{b.dimension.sortable=true;b.addSortCls(a.direction);b.dimension.direction=a.direction}b.fireEvent("sortchange",b,a.direction)},onShowFilter:function(b){var h=this,g,i,f,c={},e,d,a=h.dimension.filter,j={mztype:b.mztype,type:b.filterType,value:(a?a.value:""),from:(a?a.from:""),to:(a?a.to:""),caseSensitive:(a?a.caseSensitive:false),topSort:(a?a.topSort:false)};d=[];Ext.each(h.ownerCt.aggregateDimensions,function(k){d.push([k.header,k.id])});if(b.mztype=="label"||(b.mztype=="value"&&b.filterType!=Mz.aggregate.filter.Value.TypeTop10)){e=[[h.equalsLText,Mz.aggregate.filter.Label.TypeEquals],[h.doesNotEqualLText,Mz.aggregate.filter.Label.TypeDoesNotEqual],[h.greaterThanLText,Mz.aggregate.filter.Label.TypeGreaterThan],[h.greaterThanOrEqualToLText,Mz.aggregate.filter.Label.TypeGreaterThanOrEqualTo],[h.lessThanLText,Mz.aggregate.filter.Label.TypeLessThan],[h.lessThanOrEqualToLText,Mz.aggregate.filter.Label.TypeLessThanOrEqualTo],[h.betweenLText,Mz.aggregate.filter.Label.TypeBetween],[h.notBetweenLText,Mz.aggregate.filter.Label.TypeNotBetween]];if(b.mztype=="label"){Ext.Array.insert(e,3,[[h.beginsWithLText,Mz.aggregate.filter.Label.TypeBeginsWith],[h.doesNotBeginWithLText,Mz.aggregate.filter.Label.TypeDoesNotBeginWith],[h.endsWithLText,Mz.aggregate.filter.Label.TypeEndsWith],[h.doesNotEndWithLText,Mz.aggregate.filter.Label.TypeDoesNotEndWith],[h.containsLText,Mz.aggregate.filter.Label.TypeContains],[h.doesNotContainLText,Mz.aggregate.filter.Label.TypeDoesNotContain]]);f="Mz.pivot.plugin.configurator.FilterLabelWindow"}else{f="Mz.pivot.plugin.configurator.FilterValueWindow";Ext.apply(j,{dimensionId:(a?a.dimensionId:"")});c.storeAgg=Ext.create("Ext.data.ArrayStore",{fields:["text","value"],data:d})}c.store=Ext.create("Ext.data.ArrayStore",{fields:["text","value"],data:e})}else{f="Mz.pivot.plugin.configurator.FilterTopWindow";e=[];Ext.apply(c,{storeTopOrder:Ext.create("Ext.data.ArrayStore",{fields:["text","value"],data:[[h.topOrderTopText,"top"],[h.topOrderBottomText,"bottom"]]}),storeTopType:Ext.create("Ext.data.ArrayStore",{fields:["text","value"],data:[[h.topTypeItemsText,"items"],[h.topTypePercentText,"percent"],[h.topTypeSumText,"sum"]]}),storeAgg:Ext.create("Ext.data.ArrayStore",{fields:["text","value"],data:d})});Ext.apply(j,{type:Mz.aggregate.filter.Value.TypeTop10,dimensionId:(a?a.dimensionId:""),topType:(a?a.topType:"items"),topOrder:(a?a.topOrder:"top")})}g=Ext.create(f,Ext.apply(c||{},{title:h.header,listeners:{filter:h.onApplyFilter,scope:h}}));g.down("form").getForm().setValues(j);g.show()},onApplyFilter:function(c){var b=this,a=c.down("form").getForm().getValues();a.caseSensitive=(a.caseSensitive==="on");a.topSort=(a.topSort==="on");c.close();b.addFilterCls();b.dimension.filter=a;b.fireEvent("filterchange",b,a)},onRemoveFilter:function(){var a=this;a.removeFilterCls();a.dimension.filter=null;a.fireEvent("filterchange",a,null)}});Ext.define("Mz.pivot.plugin.configurator.DragZone",{extend:Ext.dd.DragZone,configColumnSelector:"."+Ext.baseCSSPrefix+"config-column",configColumnInnerSelector:"."+Ext.baseCSSPrefix+"config-column-inner",maxProxyWidth:120,dragging:false,constructor:function(a){this.panel=a;this.ddGroup=this.getDDGroup();this.callParent([a.el])},getDDGroup:function(){return"configurator-"+this.panel.up("gridpanel").id},getDragData:function(b){if(b.getTarget(this.configColumnInnerSelector)){var d=b.getTarget(this.configColumnSelector),a,c;if(d){a=Ext.getCmp(d.id);if(!this.panel.dragging){c=document.createElement("div");c.innerHTML=a.header;return{ddel:c,header:a}}}}return false},onBeforeDrag:function(){return !(this.panel.dragging||this.disabled)},onInitDrag:function(){this.panel.dragging=true;this.callParent(arguments)},onDragDrop:function(){if(!this.dragData.dropLocation){this.panel.dragging=false;this.callParent(arguments);return}var b=this.dragData.dropLocation.header,a=this.dragData.header,c=-1;if(b instanceof Ext.grid.column.Column){b.show();c=this.panel.items.findIndex("idColumn",a.id);this.panel.remove(this.panel.items.getAt(c));this.panel.notifyGroupChange()}this.panel.dragging=false;this.callParent(arguments)},afterRepair:function(){this.callParent();this.panel.dragging=false},getRepairXY:function(){return this.dragData.header.el.getXY()},disable:function(){this.disabled=true},enable:function(){this.disabled=false}});Ext.define("Mz.pivot.plugin.configurator.DropZone",{extend:Ext.dd.DropZone,proxyOffsets:[-4,-9],configPanelCls:Ext.baseCSSPrefix+"config-panel-ct",configColumnCls:Ext.baseCSSPrefix+"config-column",constructor:function(a){this.panel=a;this.ddGroup=this.getDDGroup();this.callParent([a.id])},disable:function(){this.disabled=true},enable:function(){this.disabled=false},getDDGroup:function(){return"configurator-"+this.panel.up("gridpanel").id},getTargetFromEvent:function(a){return a.getTarget("."+this.configColumnCls)||a.getTarget("."+this.configPanelCls)},getTopIndicator:function(){if(!this.topIndicator){this.self.prototype.topIndicator=Ext.DomHelper.append(Ext.getBody(),{cls:"col-move-top "+Ext.baseCSSPrefix+"col-move-top",html:"&#160;"},true);this.self.prototype.indicatorXOffset=Math.floor((this.topIndicator.dom.offsetWidth+1)/2)}return this.topIndicator},getBottomIndicator:function(){if(!this.bottomIndicator){this.self.prototype.bottomIndicator=Ext.DomHelper.append(Ext.getBody(),{cls:"col-move-bottom "+Ext.baseCSSPrefix+"col-move-bottom",html:"&#160;"},true)}return this.bottomIndicator},getLocation:function(f,b){var a=f.getXY()[0],d=Ext.getCmp(b.id),c,g;if(d instanceof Mz.pivot.plugin.configurator.Container){if(d.items.getCount()>0){c=Ext.fly(d.items.last().el).getRegion()}else{c=new Ext.util.Region(0,1000000,0,0)}}else{c=Ext.fly(b).getRegion()}if((c.right-a)<=(c.right-c.left)/2){g="after"}else{g="before"}return{pos:g,header:Ext.getCmp(b.id),node:b}},positionIndicator:function(A,o,u){var z=this,p=A.header,f=z.getLocation(u,o),j=f.header,d=f.pos,c,t,l,r,s,a,b,k,m,y,x,n,h,q,g,w=Ext.getVersion("extjs").match("4.1");if(j===z.lastTargetHeader&&d===z.lastDropPos){return}c=p.nextSibling("gridcolumn:not([hidden])");t=p.previousSibling("gridcolumn:not([hidden])");z.lastTargetHeader=j;z.lastDropPos=d;A.dropLocation=f;if((p!==j)&&((d==="before"&&c!==j)||(d==="after"&&t!==j))&&!j.isDescendantOf(p)){n=Ext.dd.DragDropManager.getRelated(z);h=n.length;q=0;for(;q<h;q++){g=n[q];if(g!==z&&g.invalidateDrop){g.invalidateDrop()}}z.valid=true;l=z.getTopIndicator();r=z.getBottomIndicator();if(d==="before"){s=(!w?"b":"")+"c-tl";a=(!w?"t":"")+"c-bl"}else{s=(!w?"b":"")+"c-tr";a=(!w?"t":"")+"c-br"}if(j instanceof Mz.pivot.plugin.configurator.Container&&j.items.getCount()>0){b=l.getAlignToXY(j.items.last().el,s);k=r.getAlignToXY(j.items.last().el,a)}else{b=l.getAlignToXY(j.el,s);k=r.getAlignToXY(j.el,a)}m=z.panel.el;y=m.getX()-z.indicatorXOffset;x=m.getX()+m.getWidth();b[0]=Ext.Number.constrain(b[0],y,x);k[0]=Ext.Number.constrain(k[0],y,x);l.setXY(b);r.setXY(k);l.show();r.show()}else{z.invalidateDrop()}},invalidateDrop:function(){this.valid=false;this.hideIndicators()},onNodeOver:function(c,g,f,d){var h=this,j=d.header,a,k,b,i;a=true;if(d.header.el.dom===c){a=false}if(a){h.positionIndicator(d,c,f)}else{h.valid=false}return h.valid?h.dropAllowed:h.dropNotAllowed},hideIndicators:function(){var a=this;a.getTopIndicator().hide();a.getBottomIndicator().hide();a.lastTargetHeader=a.lastDropPos=null},onNodeOut:function(){this.hideIndicators()},onNodeDrop:function(b,h,g,d){var j=this,c=d.header,f=d.dropLocation,a,k,i;if(j.valid&&f){if(h.id!=j.panel.id){k=j.panel.getColumnPosition(f.header,f.pos);a=c.serialize();if(!j.panel.isAgg){h.panel.remove(c)}j.panel.addColumn(a.dimension,k,true)}else{j.panel.moveColumn(c.id,f.header instanceof Mz.pivot.plugin.configurator.Container?f.header.items.last().id:f.header.id,f.pos)}}}});Ext.define("Mz.pivot.plugin.configurator.Container",{extend:Ext.container.Container,alias:"widget.mzconfigcontainer",style:"overflow:hidden",childEls:["innerCt","targetEl"],layout:"column",handleSorting:false,handleFiltering:false,isAgg:false,height:"auto",dragDropText:"Drop Column Fields Here",baseCls:Ext.baseCSSPrefix+"config-panel-ct",destroy:function(){var a=this;Ext.destroy(a.dragZone,a.dropZone,a.relayers,a.targetEl);a.callParent()},enable:function(){var a=this;if(a.dragZone){a.dragZone.enable()}if(a.dropZone){a.dropZone.enable()}},disable:function(){var a=this;if(a.dragZone){a.dragZone.disable()}if(a.dropZone){a.dropZone.disable()}},afterRender:function(){var a=this;a.callParent();a.dragZone=new Mz.pivot.plugin.configurator.DragZone(a);a.dropZone=new Mz.pivot.plugin.configurator.DropZone(a);a.mon(a,"afterlayout",a.showGroupByText,a)},addColumn:function(b,g,c){var d=this,e,a={},f=d.items.findIndex("dimensionId",new RegExp("^"+b.id+"$","i"))>=0;if(!d.isAgg){if(f){if(c===true){d.notifyGroupChange()}return}}else{if(f){b.id=Ext.id()}}if(d.items.getCount()==0){d.hideGroupByText()}Ext.apply(a,{dimension:b,dimensionId:b.id,header:b.header,isCustomizable:d.isCustomizable,isAgg:d.isAgg});if(d.isAgg){b.aggregator=b.aggregator||"sum"}e=Ext.create("Mz.pivot.plugin.configurator.Column",a);if(g!=-1){d.insert(g,e)}else{d.add(e)}d.updateColumnIndexes();e.relayers=d.relayEvents(e,["sortchange","filterchange","configchange"]);if(c===true){d.notifyGroupChange()}},getColumnPosition:function(b,a){var c=this,d;if(b instanceof Mz.pivot.plugin.configurator.Column){d=c.items.findIndex("id",b.id);d=(a==="before")?d:d+1}else{d=-1}return d},moveColumn:function(e,b,a){var d=this,f=d.items.findIndex("id",e),c=d.items.findIndex("id",b);if(f!=c){if(c>f){c=(a==="before")?Math.max(c-1,0):c}else{c=(a==="before")?c:c+1}d.move(f,c);d.updateColumnIndexes();d.notifyGroupChange()}},updateColumnIndexes:function(){var a=this;a.items.each(function(d,b,c){d.index=b})},notifyGroupChange:function(){var a=this;a.fireEvent("configchange")},showGroupByText:function(){var a=this,b;if(a.items.getCount()===0){a.innerCt.setHeight(a.minHeight);if(a.targetEl){b=a.targetEl.setHtml?"setHtml":"setHTML";a.targetEl[b]('<div class="'+Ext.baseCSSPrefix+'config-panel-text">'+a.dragDropText+"</div>")}else{a.targetEl=a.innerCt.createChild()}}},hideGroupByText:function(){var a=this,b;if(a.targetEl){b=a.targetEl.setHtml?"setHtml":"setHTML";a.targetEl[b]("")}}});Ext.define("Mz.pivot.plugin.configurator.Panel",{extend:Ext.container.Container,alias:"widget.mzconfigpanel",dock:"top",weight:50,minHeight:78,grid:null,fields:[],refreshDelay:1000,panelAllFieldsText:"Drop Unused Fields Here",panelTopFieldsText:"Drop Column Fields Here",panelLeftFieldsText:"Drop Row Fields Here",panelAggFieldsText:"Drop Agg Fields Here",initComponent:function(){var b=this,a={configchange:b.onConfigChanged,sortchange:b.onSortChanged,filterchange:b.onFilterChanged,scope:b,destroyable:true};Ext.apply(b,{defaults:{xtype:"mzconfigcontainer",minHeight:b.minHeight/3},items:[{itemId:"fieldsCt",label:"All fields",isCustomizable:false,dragDropText:b.panelAllFieldsText},{itemId:"fieldsAggCt",label:"Aggregate",isCustomizable:true,isAgg:true,dragDropText:b.panelAggFieldsText},{defaults:{xtype:"mzconfigcontainer",minHeight:b.minHeight/3,flex:1},xtype:"container",minHeight:b.minHeight/3,layout:{type:"hbox",align:"stretchmax"},items:[{itemId:"fieldsLeftCt",label:"Left axis",pivotField:"leftAxis",isCustomizable:true,dragDropText:b.panelLeftFieldsText},{itemId:"fieldsTopCt",label:"Top axis",pivotField:"topAxis",isCustomizable:true,dragDropText:b.panelTopFieldsText}]}]});b.callParent(arguments);b.fieldsCt=b.down("#fieldsCt");b.fieldsTopCt=b.down("#fieldsTopCt");b.fieldsLeftCt=b.down("#fieldsLeftCt");b.fieldsAggCt=b.down("#fieldsAggCt");b.fieldsCtListeners=b.fieldsCt.on(a);b.fieldsLeftCtListeners=b.fieldsLeftCt.on(a);b.fieldsTopCtListeners=b.fieldsTopCt.on(a);b.fieldsAggCtListeners=b.fieldsAggCt.on(a);b.fieldsExtracted=false;b.gridListeners=b.grid.on({pivotdone:b.initPivotFields,scope:b,destroyable:true});b.task=new Ext.util.DelayedTask(function(){b.grid.reconfigurePivot({topAxis:b.getFieldsFromContainer(b.fieldsTopCt),leftAxis:b.getFieldsFromContainer(b.fieldsLeftCt),aggregate:b.getFieldsFromContainer(b.fieldsAggCt)})})},destroy:function(){var a=this;delete (a.grid);Ext.destroy(a.relayers,a.fieldsCtListeners,a.fieldsLeftCtListeners,a.fieldsTopCtListeners,a.fieldsAggCtListeners,a.gridListeners);a.callParent()},enable:function(){var a=this;if(a.fieldsCt){a.fieldsCt.enable();a.fieldsTopCt.enable();a.fieldsLeftCt.enable();a.fieldsAggCt.enable();a.initPivotFields()}a.show()},disable:function(){var a=this;if(a.fieldsCt){a.fieldsCt.disable();a.fieldsTopCt.disable();a.fieldsLeftCt.disable();a.fieldsAggCt.disable()}a.hide()},onConfigChanged:function(){var d=this,b=[],c=[],a=[];if(d.disabled){return}d.task.delay(d.refreshDelay)},getFieldsFromContainer:function(b,c){var a=[];b.items.each(function(d){a.push(d.dimension)});return a},onSortChanged:function(b,d){var c=this,a;if(c.disabled){return}a=c.grid[b.ownerCt.pivotField];Ext.each(a,function(e){if(e.dataIndex==b.dataIndex){e.direction=d;return false}});c.task.delay(c.refreshDelay)},onFilterChanged:function(c,b){var d=this,a;if(d.disabled){return}d.task.delay(d.refreshDelay)},initPivotFields:function(){var j=this,k=j.grid.getStore(),h=k?k.model:null,i=h?h.getFields():[],f=[],d=[],a=[],e=[],b,c,g;if(h!=j.lastModel){Ext.destroy(j.lastFields);delete (j.lastFields);j.lastModel=h}if(!j.lastFields){j.lastFields=j.fetchAllFieldConfigurations()}c=j.lastFields.clone();j.fieldsCt.removeAll();j.fieldsTopCt.removeAll();j.fieldsLeftCt.removeAll();j.fieldsAggCt.removeAll();d=j.getConfigFields(j.grid.topAxis);a=j.getConfigFields(j.grid.leftAxis);e=j.getConfigFields(j.grid.aggregate);g=function(m){var l=j.lastFields.getByKey(m.header),n;if(l){n=l.id;Ext.apply(l,m);l.id=n}};Ext.each(Ext.Array.merge(d,a),function(m){var l,n=false;if(m.filter&&m.filter.dimensionId){for(l=0;l<e.length;l++){if(e[l].id==m.filter.dimensionId){n=true;break}}if(!n){delete m.filter}}c.removeAtKey(m.header);g(m)});Ext.each(e,function(l){g(l)});Ext.suspendLayouts();j.addFieldsToConfigurator(c.getRange(),j.fieldsCt);j.addFieldsToConfigurator(d,j.fieldsTopCt);j.addFieldsToConfigurator(a,j.fieldsLeftCt);j.addFieldsToConfigurator(e,j.fieldsAggCt);j.fieldsTopCt.aggregateDimensions=e;j.fieldsLeftCt.aggregateDimensions=e;Ext.resumeLayouts(true)},fetchAllFieldConfigurations:function(){var c=this,b=c.grid.getStore(),a=b?b.model.getFields():[],e=[],d;d=Ext.create("Ext.util.MixedCollection");d.getKey=function(f){return f.header};if(c.fields.length>0){e=c.fields}else{Ext.each(a,function(f){e.push({header:Ext.String.capitalize(f.name),dataIndex:f.name,direction:f.sortDir})})}Ext.each(e,function(f){f.id=f.id||Ext.id()});d.addAll(e);return d},addFieldsToConfigurator:function(a,b){Ext.each(a,function(e,d,c){b.addColumn(e,-1)})},getConfigFields:function(c){var b=this,a=[];Ext.each(c,function(e){var d=Ext.clone(e);if(b.grid.matrix.aggregate.getByKey(e.id)){Ext.apply(d,{values:b.grid.matrix.aggregate.getByKey(e.id).values})}d.id=d.id||Ext.id();if(!b.lastFields.getByKey(d.header)){b.lastFields.add(d)}a.push(d)});return a}});Ext.define("Mz.pivot.plugin.Configurator",{extend:Ext.AbstractPlugin,alias:"plugin.mzconfigurator",fields:[],refreshDelay:300,lockableScope:"top",init:function(a){var b=this;if(a.down("mzconfigpanel")){return}b.grid=a;b.fields=Ext.Array.from(b.fields);b.gridListeners=b.grid.on({beforerender:b.onBeforeGridRendered,afterrender:b.onAfterGridRendered,single:true,scope:b,destroyable:true})},destroy:function(){var a=this;delete a.grid;delete a.fields;if(a.gridMaster){delete a.gridMaster}Ext.destroy(a.fieldsCt,a.gridListeners,a.gridStateListeners);a.callParent(arguments)},enable:function(){var a=this;a.disabled=false;if(a.configCt){a.configCt.enable()}if(a.gridMaster){a.gridMaster.fireEvent("showconfigpanel",a.configCt)}},disable:function(){var a=this;a.disabled=true;if(a.configCt){a.configCt.disable()}if(a.gridMaster){a.gridMaster.fireEvent("hideconfigpanel",a.configCt)}},onBeforeGridRendered:function(){var a=this;if(a.grid instanceof Mz.pivot.Grid){a.gridMaster=a.grid}else{a.gridMaster=a.grid.up("mzpivotgrid")}if(!a.gridMaster){a.destroy();return}if(a.gridMaster.down("mzconfigpanel")){a.destroy();return}a.configCt=a.gridMaster.addDocked({xtype:"mzconfigpanel",grid:a.gridMaster,fields:a.fields,refreshDelay:a.refreshDelay})[0];if(!Ext.getVersion("extjs").match(5)){a.gridMaster.addEvents("configchange","fieldsort","showconfigpanel","hideconfigpanel")}},onAfterGridRendered:function(){var a=this;if(a.disabled===true){a.disable()}else{a.enable()}}});Ext.define("Mz.pivot.plugin.drilldown.PagingMemoryProxy",{extend:Ext.data.proxy.Memory,alias:"proxy.mzpagingmemory",read:function(c,g,h){var d=this.getReader(),i=d.read(this.data),e,a,f,b;h=h||this;a=c.filters;if(a&&a.length>0){b=[];Ext.each(i.records,function(j){var o=true,p=a.length,k;for(k=0;k<p;k++){var n=a[k],m=n.filterFn,l=n.scope;o=o&&m.call(l,j)}if(o){b.push(j)}},this);i.records=b;i.totalRecords=i.total=b.length}e=c.sorters;if(e&&e.length>0){f=function(l,k){var j=e[0].sort(l,k),n=e.length,m;for(m=1;m<n;m++){j=j||e[m].sort.call(this,l,k)}return j};i.records.sort(f)}if(c.start!==undefined&&c.limit!==undefined){i.records=i.records.slice(c.start,c.start+c.limit);i.count=i.records.length}Ext.apply(c,{resultSet:i});c.setCompleted();c.setSuccessful();Ext.Function.defer(function(){Ext.callback(g,h,[c])},10)}});Ext.define("Mz.pivot.plugin.DrillDown",{alias:"plugin.mzdrilldown",extend:Ext.AbstractPlugin,mixins:{observable:Ext.util.Observable},columns:[],width:400,height:300,textWindow:"Drill down window",lockableScope:"top",init:function(a){var b=this;b.gridListeners=a.on({afterrender:b.onGridRendered,scope:b,destroyable:true});b.callParent(arguments)},destroy:function(){var a=this;Ext.destroy(a.view,a.gridListeners,a.pivotListeners);delete a.pivot;delete a.view},onGridRendered:function(a){var b=this;b.pivot=(Mz.pivot.Grid&&a instanceof Mz.pivot.Grid)?a:a.up("mzpivotgrid");if(!b.pivot||(b.pivot&&b.pivot.hasDrillDown)){return}b.pivot.hasDrillDown=true;b.pivotListeners=b.pivot.on({pivotitemcelldblclick:b.runPlugin,pivotgroupcelldblclick:b.runPlugin,pivottotalcelldblclick:b.runPlugin,scope:b,destroyable:true})},showView:function(d){var g=this;if(!g.view){var a=g.pivot.getMatrix().store.model.getFields(),f=g.columns,b=Ext.getVersion("extjs"),e="mzpagingmemory",c;if(b.isGreaterThanOrEqual&&b.isGreaterThanOrEqual(5)){e="memory"}c=Ext.create("Ext.data.Store",{pageSize:25,remoteSort:true,fields:Ext.clone(a),proxy:{type:e,reader:{type:"array"}}});if(f.length===0){Ext.Array.each(a,function(j,h,i){f.push({header:Ext.String.capitalize(j.name),dataIndex:j.name})})}g.view=Ext.create("Ext.window.Window",{title:g.textWindow,width:g.width,height:g.height,layout:"fit",modal:true,closeAction:"hide",items:[{xtype:"grid",border:false,viewConfig:{loadMask:false},columns:f,store:c,dockedItems:[{itemId:"idPager",xtype:"pagingtoolbar",store:c,dock:"bottom",displayInfo:true}]}]});g.store=c}g.store.getProxy().data=d;g.store.load();g.view.down("#idPager").moveFirst();g.view.show()},runPlugin:function(g,f,c){if(this.disabled){return}var d=this,b=d.pivot.getMatrix(),a;if(g.topKey){a=b.results.get(g.leftKey,g.topKey);if(a){d.showView(a.records)}}}});Ext.define("Mz.pivot.plugin.ExcelExport",{alias:"plugin.mzexcelexport",extend:Ext.AbstractPlugin,constructor:function(a){var b=this;a=a||{};b.config=Ext.apply({showTitle:true,title:"Workbook",cellFontName:"Arial",cellFontSize:"10",cellBorderColor:"#E4E4E4",cellFillColor:"",titleFontSize:"14",titleFillColor:"",headerFontSize:"10",headerFillColor:"#BFBFBF",groupHeaderFontSize:"10",groupHeaderFillColor:"#D8D8D8",groupFooterFontSize:"10",groupFooterFillColor:"#BFBFBF",dateFormat:"Short Date",numberFormat:"Standard",hasDefaultStyle:true,windowHeight:9000,windowWidth:50000,protectStructure:false,protectWindows:false},a)},init:function(a){var b=this;b.grid=a;b.config=Ext.clone(b.config);b.gridListeners=b.grid.on({beforerender:b.onBeforeGridRendered,single:true,scope:b,destroyable:true})},destroy:function(){var a=this;delete a.grid;if(a.gridMaster){delete a.gridMaster}Ext.destroy(a.gridListeners);a.callParent(arguments)},onBeforeGridRendered:function(){var a=this;if(a.grid instanceof Mz.pivot.Grid){a.gridMaster=a.grid}else{a.gridMaster=a.grid.up("mzpivotgrid")}if(!a.gridMaster){a.destroy();return}},getExcelData:function(a){var b=this;if(!b.gridMaster){return}var c=Ext.create("Mz.pivot.dataexport.excel.Formatter",{matrix:b.gridMaster.getMatrix(),onlyExpandedNodes:a,config:b.config});return c.format()}});Ext.define("Mz.pivot.plugin.RangeEditor",{alias:"plugin.mzrangeeditor",extend:Ext.AbstractPlugin,mixins:{observable:Ext.util.Observable},width:280,height:180,textWindowTitle:"Range editor",textFieldValue:"Value",textFieldEdit:"Field",textFieldType:"Type",textButtonOk:"Ok",textButtonCancel:"Cancel",textTypePercentage:"Percentage",textTypeIncrement:"Increment",textTypeOverwrite:"Overwrite",textTypeUniformly:"Uniformly",onBeforeRecordsUpdate:Ext.emptyFn,onAfterRecordsUpdate:Ext.emptyFn,lockableScope:"top",TYPE_PERCENTAGE:0,TYPE_INCREMENT:1,TYPE_OVERWRITE:2,TYPE_UNIFORMLY:3,init:function(a){var b=this;b.pivot=(a instanceof Mz.pivot.Grid)?a:a.up("mzpivotgrid")||a.view.pivotGrid;if(!a){return}b.mon(a,{pivotitemcelldblclick:b.runPlugin,pivotgroupcelldblclick:b.runPlugin,pivottotalcelldblclick:b.runPlugin,scope:b},b);b.callParent(arguments)},destroy:function(){var a=this;Ext.destroy(a.editorWin);delete a.currentRecord;delete a.currentCol;delete a.editorWin;delete a.pivot;a.callParent(arguments)},runPlugin:function(g,f,c){if(this.disabled){return}var d=this,a=d.pivot.getMatrix(),b;if(g.topKey){d.initEditorWindow();d.currentResult=a.results.get(g.leftKey,g.topKey);if(d.currentResult){d.currentCol=g.column;b=d.currentCol.dimension.getId();d.editorWin.down("form").getForm().setValues({field:d.currentCol.text,value:d.currentResult.getValue(b),type:d.TYPE_OVERWRITE});d.editorWin.show()}}},updateRecords:function(){var b=this,e=b.pivot.getMatrix(),i=b.currentResult,c=b.currentCol,f=c.dimension.getId(),d=c.dimension.dataIndex,g=b.editorWin.down("form").getForm().getValues(),a,h=0;a=i.records;if(b.onBeforeRecordsUpdate(b.pivot,c,a,g.value,i.getValue(f))===false){return}b.editorWin.getEl().mask();g.value=parseFloat(g.value);Ext.defer(function(){Ext.Array.each(a,function(l){var k=l.get(d),m,j;switch(g.type){case b.TYPE_PERCENTAGE:j=Math.floor(k*g.value/100);break;case b.TYPE_INCREMENT:j=k+g.value;break;case b.TYPE_OVERWRITE:j=g.value;break;case b.TYPE_UNIFORMLY:m=(1/a.length*g.value)+h;j=Math.floor(m);h+=(m-j);break}if(k!=j){l.set(d,j)}});b.onAfterRecordsUpdate(b.pivot,c,a,g.value,i.getValue(f));b.editorWin.getEl().unmask();b.editorWin.close()},10)},initEditorWindow:function(){var a=this;if(!a.editorWin){a.editorWin=Ext.create("Ext.window.Window",{title:a.textWindowTitle,width:a.width,height:a.height,layout:"fit",modal:true,closeAction:"hide",items:[{xtype:"form",padding:5,border:false,defaults:{anchor:"100%"},items:[{fieldLabel:a.textFieldEdit,xtype:"displayfield",name:"field"},{fieldLabel:a.textFieldType,xtype:"combo",name:"type",queryMode:"local",valueField:"id",displayField:"text",editable:false,store:Ext.create("Ext.data.Store",{fields:["id","text"],data:[{id:a.TYPE_PERCENTAGE,text:a.textTypePercentage},{id:a.TYPE_INCREMENT,text:a.textTypeIncrement},{id:a.TYPE_OVERWRITE,text:a.textTypeOverwrite},{id:a.TYPE_UNIFORMLY,text:a.textTypeUniformly}]})},{fieldLabel:a.textFieldValue,xtype:"numberfield",name:"value"}]}],buttons:[{text:a.textButtonOk,handler:a.updateRecords,scope:a},{text:a.textButtonCancel,handler:function(){a.editorWin.close()}}]})}}});Ext.define("Mz.pivot.plugin.configurator.FilterTopWindow",{extend:Ext.window.Window,width:450,height:170,modal:true,closeAction:"destroy",titleText:"Top 10 filter ({0})",fieldText:"Show",sortResultsText:"Sort results",initComponent:function(){var b=this,a=[];a.push({xtype:"combo",editable:false,queryMode:"local",valueField:"value",store:b.storeTopOrder,name:"topOrder"},{xtype:"textfield",margin:"0 0 0 5",name:"value"},{xtype:"combo",margin:"0 0 0 5",editable:false,queryMode:"local",valueField:"value",store:b.storeTopType,name:"topType"},{xtype:"combo",margin:"0 0 0 5",editable:false,queryMode:"local",valueField:"value",store:b.storeAgg,name:"dimensionId"});Ext.apply(b,{title:Ext.String.format(b.titleText,b.title),layout:"fit",items:[{xtype:"form",bodyPadding:5,defaults:{allowBlank:false},items:[{xtype:"hidden",name:"mztype"},{xtype:"hidden",name:"type"},{xtype:"fieldcontainer",labelSeparator:"",fieldLabel:b.fieldText,labelAlign:"top",layout:{type:"hbox",align:"stretch"},defaults:{flex:1,allowBlank:false},items:a},{xtype:"checkbox",boxLabel:b.sortResultsText,name:"topSort"}]}],buttons:[{text:Ext.Msg.buttonText.ok,handler:b.applyFilter,scope:b},{text:Ext.Msg.buttonText.cancel,handler:b.cancelFilter,scope:b}]});b.callParent(arguments)},applyFilter:function(){var a=this;if(a.down("form").getForm().isValid()){a.fireEvent("filter",a)}},cancelFilter:function(){this.close()}});Ext.define("Mz.pivot.plugin.configurator.FilterValueWindow",{extend:Mz.pivot.plugin.configurator.FilterLabelWindow,width:500,height:150,titleText:"Value filter ({0})",fieldText:"Show items for which",initComponent:function(){var a=this;a.filterFields=[{xtype:"combo",editable:false,queryMode:"local",valueField:"value",store:a.storeAgg,name:"dimensionId"}];a.callParent(arguments)}});